<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Route Itinerary â€” DabApp</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet" />
    <style>
        :root {
            --bg: #0d0f14;
            --surface: #13161e;
            --surface2: #1a1e28;
            --surface3: #222736;
            --border: #2a3045;
            --accent: #f97316;
            --accent2: #fb923c;
            --accent-glow: rgba(249,115,22,.15);
            --text: #e8eaf0;
            --text2: #9ba3bc;
            --text3: #5c6480;
            --green: #22d3a5;
            --red: #f25c78;
            --yellow: #f5c842;
            --blue: #60a5fa;
            --purple: #a78bfa;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body { background: var(--bg); color: var(--text); font-family: "DM Sans", Arial, sans-serif; font-size: 14px; }
        h1,h2,h3,h4,h5 { font-family: "Syne", sans-serif; }

        /* â”€â”€ HEADER â”€â”€ */
        .header {
            height: 60px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            flex-shrink: 0;
            position: relative;
            z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-logo { font-family: "Syne", sans-serif; font-size: 18px; font-weight: 800; }
        .header-logo span { color: var(--accent); }
        .header-title { font-size: 15px; font-weight: 600; color: var(--text); }
        .header-sub { font-size: 11px; color: var(--text3); margin-top: 1px; }
        .header-right { display: flex; align-items: center; gap: 10px; }

        /* â”€â”€ BUTTONS â”€â”€ */
        .btn { display: inline-flex; align-items: center; gap: 7px; padding: 8px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; border: none; font-family: inherit; transition: all .15s; }
        .btn-primary { background: var(--accent); color: #fff; }
        .btn-primary:hover { background: var(--accent2); }
        .btn-ghost { background: transparent; color: var(--text2); border: 1px solid var(--border); }
        .btn-ghost:hover { background: var(--surface2); color: var(--text); }
        .btn-danger { background: rgba(242,92,120,.15); color: var(--red); border: 1px solid rgba(242,92,120,.25); }
        .btn-danger:hover { background: rgba(242,92,120,.25); }
        .btn-success { background: rgba(34,211,165,.15); color: var(--green); border: 1px solid rgba(34,211,165,.25); }
        .btn-success:hover { background: rgba(34,211,165,.25); }

        /* â”€â”€ LAYOUT â”€â”€ */
        .app { display: flex; height: calc(100vh - 60px); }

        /* â”€â”€ SIDEBAR â”€â”€ */
        .sidebar {
            width: 380px;
            flex-shrink: 0;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .sidebar-tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .6px;
            cursor: pointer;
            color: var(--text3);
            border-bottom: 2px solid transparent;
            transition: all .15s;
        }
        .sidebar-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .sidebar-tab:hover:not(.active) { color: var(--text2); }

        .tab-panel { flex: 1; overflow-y: auto; display: none; }
        .tab-panel.active { display: block; }
        .tab-panel::-webkit-scrollbar { width: 5px; }
        .tab-panel::-webkit-scrollbar-track { background: transparent; }
        .tab-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

        /* â”€â”€ ROUTE INFO â”€â”€ */
        .route-info-block {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }
        .route-name {
            font-size: 17px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 6px;
        }
        .route-desc {
            font-size: 12px;
            color: var(--text3);
            line-height: 1.5;
            margin-bottom: 14px;
        }
        .route-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .stat-box {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }
        .stat-val {
            font-size: 20px;
            font-weight: 800;
            font-family: "Syne", sans-serif;
            color: var(--accent);
        }
        .stat-val.green { color: var(--green); }
        .stat-val.blue { color: var(--blue); }
        .stat-val.yellow { color: var(--yellow); }
        .stat-lbl {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: .5px;
            color: var(--text3);
            margin-top: 3px;
        }

        /* â”€â”€ WAYPOINT ITEMS â”€â”€ */
        .section-title {
            padding: 14px 16px 8px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: .8px;
            color: var(--text3);
            font-weight: 700;
        }
        .waypoint-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 16px;
            cursor: pointer;
            transition: background .15s;
            border-bottom: 1px solid var(--border);
        }
        .waypoint-item:hover { background: var(--surface2); }
        .waypoint-item:last-child { border-bottom: none; }
        .wp-num {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--accent);
            color: #fff;
            font-size: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 1px;
        }
        .wp-num.start { background: var(--green); }
        .wp-num.end { background: var(--red); }
        .wp-content { flex: 1; min-width: 0; }
        .wp-name { font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .wp-meta { font-size: 11px; color: var(--text3); margin-top: 2px; }
        .wp-services { display: flex; gap: 4px; margin-top: 4px; flex-wrap: wrap; }
        .wp-badge { font-size: 10px; background: var(--surface3); border: 1px solid var(--border); border-radius: 4px; padding: 1px 5px; color: var(--text3); }

        /* â”€â”€ INSTRUCTION STEPS â”€â”€ */
        .step-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: all .15s;
        }
        .step-item:last-child { border-bottom: none; }
        .step-item:hover { background: var(--surface2); }
        .step-item.active { background: var(--accent-glow); border-left: 3px solid var(--accent); }
        .step-icon-wrap {
            width: 32px;
            height: 32px;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        .step-item.active .step-icon-wrap { background: var(--accent-glow); border-color: rgba(249,115,22,.3); }
        .step-content { flex: 1; min-width: 0; }
        .step-num { font-size: 10px; color: var(--text3); font-weight: 700; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 3px; }
        .step-item.active .step-num { color: var(--accent); }
        .step-instr { font-size: 12px; color: var(--text); line-height: 1.4; }
        .step-dist { font-size: 11px; color: var(--text3); margin-top: 3px; }

        /* â”€â”€ ANIMATION CONTROLS â”€â”€ */
        .moto-panel {
            padding: 16px;
            border-top: 1px solid var(--border);
            background: var(--surface);
            flex-shrink: 0;
        }
        .moto-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: .8px;
            color: var(--text3);
            font-weight: 700;
            margin-bottom: 10px;
        }
        .moto-btns { display: flex; gap: 8px; margin-bottom: 10px; }
        .moto-btns .btn { flex: 1; justify-content: center; }
        .progress-bar {
            background: var(--surface2);
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 6px;
        }
        .progress-fill {
            background: linear-gradient(90deg, var(--accent), var(--accent2));
            height: 100%;
            width: 0%;
            transition: width .3s;
        }
        .progress-text { font-size: 11px; color: var(--text3); text-align: right; }

        /* â”€â”€ MAP AREA â”€â”€ */
        .map-area { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }

        /* â”€â”€ NAV PANEL (floating) â”€â”€ */
        .nav-panel {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 340px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 8px 40px rgba(0,0,0,.6);
            z-index: 500;
            overflow: hidden;
        }
        .nav-panel.hidden { display: none; }
        .nav-panel-header {
            background: var(--accent);
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .nav-panel-header span { font-size: 12px; font-weight: 700; color: #fff; }
        .nav-close {
            background: rgba(255,255,255,.2);
            border: none;
            color: #fff;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .nav-main {
            padding: 16px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }
        .nav-icon { font-size: 48px; line-height: 1; margin-bottom: 8px; }
        .nav-distance { font-size: 28px; font-weight: 800; font-family: "Syne", sans-serif; color: var(--accent); margin-bottom: 6px; }
        .nav-text { font-size: 14px; color: var(--text); line-height: 1.4; }
        .nav-stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            border-bottom: 1px solid var(--border);
        }
        .nav-stat {
            padding: 10px;
            text-align: center;
            border-right: 1px solid var(--border);
        }
        .nav-stat:last-child { border-right: none; }
        .nav-stat-val { font-size: 13px; font-weight: 700; color: var(--text); }
        .nav-stat-lbl { font-size: 10px; color: var(--text3); text-transform: uppercase; letter-spacing: .4px; margin-top: 2px; }
        .nav-next {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nav-next-label { font-size: 10px; color: var(--accent); font-weight: 700; text-transform: uppercase; white-space: nowrap; }
        .nav-next-text { font-size: 12px; color: var(--text2); }
        .nav-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 12px;
        }
        .nav-controls .btn { justify-content: center; }
        .nav-stop { margin: 0 12px 12px; display: block; width: calc(100% - 24px); justify-content: center; }

        /* â”€â”€ LOADING STATE â”€â”€ */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 16px;
            color: var(--text3);
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin .8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* â”€â”€ MAP HINT â”€â”€ */
        .map-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 7px 14px;
            font-size: 11px;
            color: var(--text2);
            white-space: nowrap;
            pointer-events: none;
            box-shadow: 0 4px 16px rgba(0,0,0,.4);
        }

        /* â”€â”€ START BUTTON OVERLAY â”€â”€ */
        .start-nav-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
        }

        /* â”€â”€ SCROLLBAR â”€â”€ */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

        /* â”€â”€ MOBILE â”€â”€ */
        @media (max-width: 900px) {
            .sidebar { width: 100%; position: fixed; top: 60px; left: -100%; z-index: 300; transition: left .3s; height: calc(100vh - 60px); }
            .sidebar.open { left: 0; }
        }
    </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="header">
    <div class="header-left">
        <div class="header-logo">Dab<span>App</span></div>
        <div style="width:1px;height:28px;background:var(--border)"></div>
        <div>
            <div class="header-title" id="headerTitle">Loading route...</div>
            <div class="header-sub" id="headerSub">Route Itinerary</div>
        </div>
    </div>
    <div class="header-right">
        <span id="authBadge" style="font-size:11px;padding:4px 10px;border-radius:20px;background:var(--surface2);border:1px solid var(--border);color:var(--text3)">â³ Loading...</span>
        <button class="btn btn-ghost" id="btnToggleSidebar" onclick="toggleSidebar()" style="display:none">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            Details
        </button>
        <button class="btn btn-ghost" onclick="goBack()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
            Back
        </button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app">

    <!-- â”€â”€ SIDEBAR â”€â”€ -->
    <div class="sidebar" id="sidebar">

        <!-- Tabs -->
        <div class="sidebar-tabs">
            <div class="sidebar-tab active" onclick="switchTab('info', this)">Route Info</div>
            <div class="sidebar-tab" onclick="switchTab('waypoints', this)">Waypoints</div>
            <div class="sidebar-tab" onclick="switchTab('steps', this)">Navigation</div>
        </div>

        <!-- TAB: Route Info -->
        <div class="tab-panel active" id="tab-info">
            <div id="routeInfoContent">
                <div class="loading-state" style="height:200px">
                    <div class="spinner"></div>
                    <span>Loading route...</span>
                </div>
            </div>
        </div>

        <!-- TAB: Waypoints -->
        <div class="tab-panel" id="tab-waypoints">
            <div class="section-title">Waypoints</div>
            <div id="waypointsList">
                <div style="padding:20px;text-align:center;color:var(--text3);font-size:12px">Load a route to see waypoints</div>
            </div>
        </div>

        <!-- TAB: Steps -->
        <div class="tab-panel" id="tab-steps">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 16px 8px">
                <span style="font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);font-weight:700">Turn-by-turn</span>
                <span id="stepCounter" style="font-size:11px;color:var(--text3)">â€” steps</span>
            </div>
            <div id="stepsList">
                <div style="padding:20px;text-align:center;color:var(--text3);font-size:12px">Load a route to see navigation steps</div>
            </div>
        </div>

        <!-- Moto animation panel (always visible at bottom) -->
        <div class="moto-panel" id="motoPanel" style="display:none">
            <div class="moto-title">ğŸï¸ Motorcycle Animation</div>
            <div class="moto-btns">
                <button class="btn btn-success btn-sm" onclick="animateMotorcycle()">â–¶ Start</button>
                <button class="btn btn-ghost btn-sm" onclick="pauseAnimation()">â¸ Pause</button>
                <button class="btn btn-danger btn-sm" onclick="stopAnimation()">â¹ Stop</button>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            <div class="progress-text" id="progressText">0%</div>
        </div>
    </div>

    <!-- â”€â”€ MAP â”€â”€ -->
    <div class="map-area">
        <div id="map">
            <div class="loading-state">
                <div class="spinner"></div>
                <span>Initializing map...</span>
            </div>
        </div>

        <!-- NAV PANEL (floating) -->
        <div class="nav-panel hidden" id="navPanel">
            <div class="nav-panel-header">
                <span>ğŸ§­ Navigation Mode</span>
                <button class="nav-close" onclick="stopNavigation()">âœ•</button>
            </div>
            <div class="nav-main">
                <div class="nav-icon" id="navIcon">â¬†ï¸</div>
                <div class="nav-distance" id="navDistance">â€”</div>
                <div class="nav-text" id="navText">â€”</div>
            </div>
            <div class="nav-stats-row">
                <div class="nav-stat">
                    <div class="nav-stat-val" id="navStep">1/1</div>
                    <div class="nav-stat-lbl">Step</div>
                </div>
                <div class="nav-stat">
                    <div class="nav-stat-val" id="navTime">â€”</div>
                    <div class="nav-stat-lbl">Duration</div>
                </div>
                <div class="nav-stat">
                    <div class="nav-stat-val" id="navRemaining">â€”</div>
                    <div class="nav-stat-lbl">Remaining</div>
                </div>
            </div>
            <div class="nav-next" id="navNext">
                <span class="nav-next-label">Next â†’</span>
                <span class="nav-next-text" id="navNextText">â€”</span>
            </div>
            <div class="nav-controls">
                <button class="btn btn-ghost" onclick="prevStep()">â† Previous</button>
                <button class="btn btn-primary" onclick="nextStep()">Next â†’</button>
            </div>
        </div>

        <!-- Start Navigation button -->
        <button class="btn btn-primary start-nav-btn hidden" id="btnStartNav" onclick="startNavigation()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polygon points="5 3 19 12 5 21 5 3"/></svg>
            Start Navigation
        </button>

        <div class="map-hint" id="mapHint">ğŸ“ Click on a waypoint to focus</div>
    </div>
</div>

<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIG
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const GMAPS_KEY = 'AIzaSyBznLyPEvm9nm3LerujutDMx1F6zNSpk2E';

    let authToken = null;
    let currentUser = null;
    let currentRoute = null;
    let map, directionsService, directionsRenderer;
    let markers = [];
    let motorcycleMarker = null;
    let animationPath = [];
    let animationInterval = null;
    let currentPathIndex = 0;
    let allSteps = [];
    let currentStepIndex = 0;
    let navigationMode = false;
    let apiBaseUrl = '';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.onload = function () {
        const params = new URLSearchParams(window.location.search);
        const routeId = params.get('id');
        const token   = params.get('token');
        const apiUrl  = params.get('api_url');

        // API base URL
        apiBaseUrl = apiUrl
            || localStorage.getItem('api_url')
            || localStorage.getItem('dabapp_api_url')
            || (window.location.hostname !== 'localhost' && window.location.protocol !== 'file:'
                ? window.location.origin
                : 'http://localhost:8000');
        apiBaseUrl = apiBaseUrl.replace(/\/$/, '');

        // Token
        if (token) {
            authToken = token;
            localStorage.setItem('auth_token', token);
        } else {
            authToken = localStorage.getItem('auth_token') || localStorage.getItem('dabapp_token');
        }

        if (!authToken) {
            updateBadge('âŒ Not authenticated', 'var(--red)');
            showError('No authentication token. Please go back and login.');
            return;
        }

        // Load user info then route
        fetchUserInfo().then(() => {
            if (routeId) {
                loadRoute(routeId);
            } else {
                showError('No route ID provided in the URL.');
            }
        });
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AUTH
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function fetchUserInfo() {
        try {
            const res = await fetch(`${apiBaseUrl}/api/user`, {
                headers: { 'Accept': 'application/json', 'Authorization': `Bearer ${authToken}` }
            });
            const data = await res.json();
            currentUser = data.user || data.data || data;
            if (currentUser && currentUser.first_name) {
                updateBadge(`âœ… ${currentUser.first_name} ${currentUser.last_name || ''}`, 'var(--green)');
            } else {
                updateBadge('âœ… Authenticated', 'var(--green)');
            }
        } catch (e) {
            updateBadge('âœ… Authenticated', 'var(--green)');
        }
    }

    function updateBadge(text, color) {
        const badge = document.getElementById('authBadge');
        badge.textContent = text;
        badge.style.color = color;
        badge.style.borderColor = color.replace('var(', '').replace(')', '');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LOAD ROUTE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadRoute(routeId) {
        document.getElementById('headerSub').textContent = `Route #${routeId}`;
        try {
            const res = await fetch(`${apiBaseUrl}/api/routes/${routeId}`, {
                headers: { 'Accept': 'application/json', 'Authorization': `Bearer ${authToken}` }
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message || 'Route not found');
            currentRoute = data.data || data;
            document.getElementById('headerTitle').textContent = currentRoute.title;
            document.getElementById('headerSub').textContent = currentRoute.difficulty ? `Route Â· ${currentRoute.difficulty}` : 'Route Itinerary';
            renderRouteInfo(currentRoute);
            renderWaypoints(currentRoute.waypoints || []);
            initGoogleMaps();
        } catch (e) {
            showError(e.message);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDER PANELS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderRouteInfo(route) {
        const diffColors = { easy: 'var(--green)', moderate: 'var(--blue)', difficult: 'var(--accent)', expert: 'var(--red)' };
        document.getElementById('routeInfoContent').innerHTML = `
            <div class="route-info-block">
                <div class="route-name">${esc(route.title)}</div>
                ${route.description ? `<div class="route-desc">${esc(route.description)}</div>` : ''}
                <div class="route-stats-grid">
                    <div class="stat-box">
                        <div class="stat-val">${route.total_distance ? route.total_distance + ' km' : 'â€”'}</div>
                        <div class="stat-lbl">Distance</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-val" style="color:${diffColors[route.difficulty]||'var(--blue)'}; font-size:14px">${route.difficulty ? route.difficulty.toUpperCase() : 'â€”'}</div>
                        <div class="stat-lbl">Difficulty</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-val blue" style="font-size:15px">${route.estimated_duration || 'â€”'}</div>
                        <div class="stat-lbl">Duration</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-val yellow">${route.rating_average > 0 ? 'â˜… ' + Number(route.rating_average).toFixed(1) : 'â€”'}</div>
                        <div class="stat-lbl">Rating</div>
                    </div>
                </div>
                ${route.best_season ? `<div style="margin-top:10px;font-size:12px;color:var(--text3)">ğŸŒ¿ Best season: <span style="color:var(--text2)">${esc(route.best_season)}</span></div>` : ''}
                ${route.road_condition ? `<div style="margin-top:4px;font-size:12px;color:var(--text3)">ğŸ›£ï¸ Road: <span style="color:var(--text2)">${esc(route.road_condition)}</span></div>` : ''}
            </div>
            <div style="padding:14px 16px">
                <button class="btn btn-primary" style="width:100%;justify-content:center" onclick="startNavigation()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    Start Navigation
                </button>
            </div>
        `;
    }

    function renderWaypoints(waypoints) {
        const typeLabel = { start:'ğŸ Start', waypoint:'ğŸ“ Waypoint', poi:'ğŸ¯ POI', rest_stop:'â˜• Rest Stop', gas_station:'â›½ Gas Station', viewpoint:'ğŸŒ„ Viewpoint', end:'ğŸ End' };
        document.getElementById('waypointsList').innerHTML = waypoints.map((wp, i) => {
            const numClass = i === 0 ? 'start' : i === waypoints.length - 1 ? 'end' : '';
            const services = [];
            if (wp.has_gas_station) services.push('â›½ Gas');
            if (wp.has_restaurant) services.push('ğŸ½ï¸ Food');
            if (wp.has_toilets) services.push('ğŸš»');
            if (wp.has_parking) services.push('ğŸ…¿ï¸');
            if (wp.has_hotel) services.push('ğŸ¨');
            return `
            <div class="waypoint-item" onclick="focusWaypoint(${i})">
                <div class="wp-num ${numClass}">${i + 1}</div>
                <div class="wp-content">
                    <div class="wp-name">${esc(wp.name)}</div>
                    <div class="wp-meta">${typeLabel[wp.waypoint_type] || 'ğŸ“ Waypoint'}${wp.pause_duration ? ` Â· â±ï¸ ${wp.pause_duration}min` : ''}</div>
                    ${services.length ? `<div class="wp-services">${services.map(s => `<span class="wp-badge">${s}</span>`).join('')}</div>` : ''}
                    ${wp.description ? `<div style="font-size:11px;color:var(--text3);margin-top:3px">${esc(wp.description)}</div>` : ''}
                </div>
            </div>`;
        }).join('');
    }

    function renderSteps(steps) {
        document.getElementById('stepCounter').textContent = `${steps.length} steps`;
        document.getElementById('stepsList').innerHTML = steps.map((step, i) => `
            <div class="step-item" id="step-${i}" onclick="focusStep(${i})">
                <div class="step-icon-wrap">${getManeuverIcon(step.maneuver)}</div>
                <div class="step-content">
                    <div class="step-num">Step ${i + 1}</div>
                    <div class="step-instr">${esc(step.instruction)}</div>
                    <div class="step-dist">ğŸ“ ${step.distance} Â· â±ï¸ ${step.duration}</div>
                </div>
            </div>
        `).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GOOGLE MAPS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function initGoogleMaps() {
        if (window.google) { setupMap(); return; }
        const s = document.createElement('script');
        s.src = `https://maps.googleapis.com/maps/api/js?key=${GMAPS_KEY}&libraries=places,geometry`;
        s.onload = setupMap;
        document.head.appendChild(s);
    }

    const mapStyles = [
        {featureType:'all',elementType:'geometry',stylers:[{color:'#1a1e28'}]},
        {featureType:'road',elementType:'geometry.fill',stylers:[{color:'#2a3045'}]},
        {featureType:'road',elementType:'labels.text.fill',stylers:[{color:'#f97316'}]},
        {featureType:'road.highway',elementType:'geometry.stroke',stylers:[{color:'#f97316'}]},
        {featureType:'water',elementType:'geometry',stylers:[{color:'#0d0f14'}]},
        {featureType:'poi',elementType:'geometry',stylers:[{color:'#13161e'}]},
        {featureType:'transit',elementType:'all',stylers:[{visibility:'off'}]},
        {featureType:'administrative',elementType:'labels.text.fill',stylers:[{color:'#9ba3bc'}]}
    ];

    function setupMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 6,
            center: { lat: 31.7917, lng: -7.0926 },
            styles: mapStyles,
            mapTypeControl: true,
            mapTypeControlOptions: { style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR, position: google.maps.ControlPosition.TOP_LEFT },
            streetViewControl: false,
            fullscreenControl: true,
        });
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map,
            suppressMarkers: true,
            polylineOptions: { strokeColor: '#f97316', strokeWeight: 5, strokeOpacity: .8 }
        });
        if (currentRoute) displayRouteOnMap(currentRoute);
    }

    function getWpColor(type, idx, total) {
        if (idx === 0 || type === 'start') return '#22d3a5';
        if (idx === total - 1 || type === 'end') return '#f25c78';
        if (type === 'gas_station') return '#60a5fa';
        if (type === 'rest_stop') return '#a78bfa';
        if (type === 'viewpoint') return '#f5c842';
        return '#f97316';
    }

    function displayRouteOnMap(route) {
        markers.forEach(m => m.setMap(null));
        markers = [];
        const wps = route.waypoints || [];
        if (wps.length < 2) return;

        wps.forEach((wp, i) => {
            const pos = { lat: parseFloat(wp.latitude), lng: parseFloat(wp.longitude) };
            const color = getWpColor(wp.waypoint_type, i, wps.length);
            const marker = new google.maps.Marker({
                position: pos, map,
                label: { text: String(i + 1), color: 'white', fontWeight: 'bold', fontSize: '11px' },
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 13, fillColor: color, fillOpacity: 1, strokeColor: '#fff', strokeWeight: 2 }
            });
            const info = new google.maps.InfoWindow({
                content: `<div style="color:#000;padding:8px;max-width:220px;font-family:sans-serif">
                    <strong>${wp.name}</strong>
                    <div style="font-size:11px;color:#555;margin-top:3px">${wp.waypoint_type}</div>
                    ${wp.description ? `<div style="font-size:12px;margin-top:4px">${wp.description}</div>` : ''}
                    ${wp.pause_duration ? `<div style="font-size:11px;color:#f97316;margin-top:4px">â±ï¸ Pause: ${wp.pause_duration}min</div>` : ''}
                </div>`
            });
            marker.addListener('click', () => info.open(map, marker));
            markers.push(marker);
        });

        const origin = new google.maps.LatLng(parseFloat(wps[0].latitude), parseFloat(wps[0].longitude));
        const dest   = new google.maps.LatLng(parseFloat(wps[wps.length-1].latitude), parseFloat(wps[wps.length-1].longitude));
        const intermediates = wps.slice(1,-1).map(wp => ({
            location: new google.maps.LatLng(parseFloat(wp.latitude), parseFloat(wp.longitude)),
            stopover: true
        }));

        directionsService.route({ origin, destination: dest, waypoints: intermediates, travelMode: google.maps.TravelMode.DRIVING }, (result, status) => {
            if (status === 'OK') {
                directionsRenderer.setDirections(result);
                extractSteps(result.routes[0]);
                animationPath = result.routes[0].overview_path;
                placeMotorcycle();
                document.getElementById('motoPanel').style.display = 'block';
                document.getElementById('btnStartNav').classList.remove('hidden');
            }
        });
    }

    function extractSteps(route) {
        allSteps = [];
        route.legs.forEach(leg => leg.steps.forEach(step => allSteps.push({
            instruction: stripHtml(step.instructions),
            distance: step.distance.text,
            duration: step.duration.text,
            maneuver: step.maneuver || 'straight',
            startLoc: step.start_location,
            endLoc: step.end_location,
        })));
        renderSteps(allSteps);
        // Switch to steps tab if it's loaded
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FOCUS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function focusWaypoint(i) {
        if (markers[i]) {
            map.setCenter(markers[i].getPosition());
            map.setZoom(15);
            google.maps.event.trigger(markers[i], 'click');
        }
    }

    function focusStep(i) {
        currentStepIndex = i;
        document.querySelectorAll('.step-item').forEach(el => el.classList.remove('active'));
        const el = document.getElementById(`step-${i}`);
        if (el) { el.classList.add('active'); el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        if (allSteps[i]) { map.setCenter(allSteps[i].startLoc); map.setZoom(16); }
        if (navigationMode) updateNavPanel();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NAVIGATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function startNavigation() {
        if (!allSteps.length) { alert('Load a route first!'); return; }
        navigationMode = true;
        currentStepIndex = 0;
        document.getElementById('navPanel').classList.remove('hidden');
        document.getElementById('btnStartNav').classList.add('hidden');
        switchTab('steps', document.querySelectorAll('.sidebar-tab')[2]);
        updateNavPanel();
        focusStep(0);
    }

    function stopNavigation() {
        navigationMode = false;
        document.getElementById('navPanel').classList.add('hidden');
        document.getElementById('btnStartNav').classList.remove('hidden');
        document.querySelectorAll('.step-item').forEach(el => el.classList.remove('active'));
    }

    function updateNavPanel() {
        const curr = allSteps[currentStepIndex];
        const next = allSteps[currentStepIndex + 1];
        if (!curr) return;
        document.getElementById('navIcon').textContent = getManeuverIcon(curr.maneuver);
        document.getElementById('navDistance').textContent = curr.distance;
        document.getElementById('navText').textContent = curr.instruction;
        document.getElementById('navStep').textContent = `${currentStepIndex + 1}/${allSteps.length}`;
        document.getElementById('navTime').textContent = curr.duration;

        // Remaining distance
        let rem = 0;
        for (let i = currentStepIndex; i < allSteps.length; i++) {
            const d = parseFloat(allSteps[i].distance.replace(/[^\d.]/g, ''));
            rem += allSteps[i].distance.includes('km') ? d : d / 1000;
        }
        document.getElementById('navRemaining').textContent = rem.toFixed(1) + ' km';

        // Next
        if (next) {
            document.getElementById('navNext').style.display = 'flex';
            document.getElementById('navNextText').textContent = `${getManeuverIcon(next.maneuver)} ${next.instruction}`;
        } else {
            document.getElementById('navNext').style.display = 'none';
        }
    }

    function nextStep() {
        if (currentStepIndex < allSteps.length - 1) focusStep(currentStepIndex + 1);
        else { alert('ğŸ You have arrived at your destination!'); stopNavigation(); }
    }

    function prevStep() {
        if (currentStepIndex > 0) focusStep(currentStepIndex - 1);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MOTORCYCLE ANIMATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function getMotorcycleIcon(rotation = 0) {
        return {
            path: 'M17.5,9.5C17.5,10.9 16.4,12 15,12C13.6,12 12.5,10.9 12.5,9.5C12.5,8.1 13.6,7 15,7C16.4,7 17.5,8.1 17.5,9.5M6.5,9.5C6.5,10.9 5.4,12 4,12C2.6,12 1.5,10.9 1.5,9.5C1.5,8.1 2.6,7 4,7C5.4,7 6.5,8.1 6.5,9.5M10.1,6.9C9.7,7.1 9.4,7.4 9.1,7.7L7,7.7C6.7,7.7 6.5,7.9 6.5,8.2C6.5,8.5 6.7,8.7 7,8.7L8.7,8.7C8.6,9 8.5,9.2 8.5,9.5C8.5,9.6 8.5,9.7 8.5,9.8L4.8,10.8C4.5,10.9 4.4,11.2 4.5,11.5C4.6,11.7 4.8,11.9 5,11.9L8.9,10.8C9.3,11.6 10.1,12.2 11,12.4L11,15L10,15C9.7,15 9.5,15.2 9.5,15.5C9.5,15.8 9.7,16 10,16L13,16C13.3,16 13.5,15.8 13.5,15.5C13.5,15.2 13.3,15 13,15L12,15L12,12.4C12.9,12.2 13.7,11.6 14.1,10.8L18,11.9C18.2,11.9 18.4,11.7 18.5,11.5C18.6,11.2 18.5,10.9 18.2,10.8L14.5,9.8C14.5,9.7 14.5,9.6 14.5,9.5C14.5,9.2 14.4,9 14.3,8.7L16,8.7C16.3,8.7 16.5,8.5 16.5,8.2C16.5,7.9 16.3,7.7 16,7.7L13.9,7.7C13.6,7.4 13.3,7.1 12.9,6.9L13.5,5.7C13.6,5.4 13.5,5.1 13.2,5C12.9,4.9 12.6,5 12.5,5.3L11.9,6.5C11.6,6.5 11.4,6.5 11.1,6.5L10.5,5.3C10.4,5 10.1,4.9 9.8,5C9.5,5.1 9.4,5.4 9.5,5.7L10.1,6.9Z',
            fillColor: '#f97316',
            fillOpacity: 1,
            strokeColor: '#fff',
            strokeWeight: 2,
            scale: 1.8,
            anchor: new google.maps.Point(10, 10),
            rotation,
        };
    }

    function placeMotorcycle() {
        if (!animationPath.length) return;
        const start = animationPath[0];
        let heading = 0;
        if (animationPath.length > 1) heading = google.maps.geometry.spherical.computeHeading(animationPath[0], animationPath[1]);
        if (motorcycleMarker) motorcycleMarker.setMap(null);
        motorcycleMarker = new google.maps.Marker({
            position: start, map,
            icon: getMotorcycleIcon(heading),
            title: 'ğŸï¸ DabApp Motorcycle',
            zIndex: 1000
        });
    }

    function animateMotorcycle() {
        if (!animationPath.length) { alert('No route loaded!'); return; }
        if (animationInterval) clearInterval(animationInterval);
        currentPathIndex = 0;
        if (!motorcycleMarker) placeMotorcycle();
        else {
            motorcycleMarker.setPosition(animationPath[0]);
            let h = 0;
            if (animationPath.length > 1) h = google.maps.geometry.spherical.computeHeading(animationPath[0], animationPath[1]);
            motorcycleMarker.setIcon(getMotorcycleIcon(h));
        }
        document.getElementById('progressFill').style.width = '0%';
        document.getElementById('progressText').textContent = '0%';

        animationInterval = setInterval(() => {
            if (currentPathIndex >= animationPath.length - 1) {
                clearInterval(animationInterval); animationInterval = null;
                document.getElementById('progressFill').style.width = '100%';
                document.getElementById('progressText').textContent = '100% â€” Arrived! ğŸ';
                return;
            }
            const curr = animationPath[currentPathIndex];
            const next = animationPath[currentPathIndex + 1];
            const heading = google.maps.geometry.spherical.computeHeading(curr, next);
            motorcycleMarker.setPosition(next);
            motorcycleMarker.setIcon(getMotorcycleIcon(heading));
            map.panTo(next);
            currentPathIndex++;
            const pct = Math.round((currentPathIndex / animationPath.length) * 100);
            document.getElementById('progressFill').style.width = pct + '%';
            document.getElementById('progressText').textContent = pct + '%';
        }, 50);
    }

    function pauseAnimation() {
        if (animationInterval) {
            clearInterval(animationInterval); animationInterval = null;
            const t = document.getElementById('progressText').textContent;
            if (!t.includes('(Paused)')) document.getElementById('progressText').textContent = t + ' (Paused)';
        }
    }

    function stopAnimation() {
        if (animationInterval) { clearInterval(animationInterval); animationInterval = null; }
        currentPathIndex = 0;
        document.getElementById('progressFill').style.width = '0%';
        document.getElementById('progressText').textContent = '0%';
        if (motorcycleMarker && animationPath.length) {
            motorcycleMarker.setPosition(animationPath[0]);
            let h = animationPath.length > 1 ? google.maps.geometry.spherical.computeHeading(animationPath[0], animationPath[1]) : 0;
            motorcycleMarker.setIcon(getMotorcycleIcon(h));
            map.panTo(animationPath[0]);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TABS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function switchTab(id, el) {
        document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        if (el) el.classList.add('active');
        const panel = document.getElementById('tab-' + id);
        if (panel) panel.classList.add('active');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function esc(s) {
        if (!s) return '';
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function stripHtml(html) {
        const d = document.createElement('div'); d.innerHTML = html;
        return d.textContent || d.innerText || '';
    }

    function getManeuverIcon(m) {
        const icons = {
            'turn-left':'â†°', 'turn-right':'â†±', 'turn-sharp-left':'â¬…ï¸', 'turn-sharp-right':'â¡ï¸',
            'turn-slight-left':'â†–ï¸', 'turn-slight-right':'â†—ï¸', 'straight':'â¬†ï¸', 'uturn-left':'â†©ï¸',
            'uturn-right':'â†ªï¸', 'roundabout-left':'ğŸ”„', 'roundabout-right':'ğŸ”„', merge:'ğŸ”€',
            'ramp-left':'â¤´ï¸', 'ramp-right':'â¤´ï¸', 'fork-left':'â†™ï¸', 'fork-right':'â†˜ï¸',
        };
        return icons[m] || 'â¬†ï¸';
    }

    function showError(msg) {
        document.getElementById('routeInfoContent').innerHTML = `
            <div style="padding:24px;text-align:center">
                <div style="font-size:32px;margin-bottom:12px">âš ï¸</div>
                <div style="color:var(--red);font-size:14px;font-weight:600;margin-bottom:8px">Error</div>
                <div style="color:var(--text3);font-size:12px">${esc(msg)}</div>
                <button class="btn btn-ghost" onclick="goBack()" style="margin-top:16px">â† Go Back</button>
            </div>`;
        document.getElementById('headerTitle').textContent = 'Error';
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
    }

    function goBack() {
        window.history.back();
    }

    // Check mobile
    if (window.innerWidth <= 900) {
        document.getElementById('btnToggleSidebar').style.display = 'inline-flex';
    }
    window.addEventListener('resize', () => {
        document.getElementById('btnToggleSidebar').style.display = window.innerWidth <= 900 ? 'inline-flex' : 'none';
    });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API POI - DabApp Style</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(90deg, #ff6b00 0%, #cc5500 100%);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            text-transform: uppercase;
        }

        .section {
            background: #2c2c2c;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #ff6b00;
        }

        .section h2 {
            color: #ff6b00;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: #ff6b00;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 13px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 5px;
            color: #fff;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ff6b00;
        }

        .form-group input[readonly] {
            background: #333;
            cursor: not-allowed;
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(90deg, #ff6b00 0%, #cc5500 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            text-transform: uppercase;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #555;
        }

        .btn-danger {
            background: #d32f2f;
        }

        .btn-success {
            background: #4caf50;
        }

        .response-box {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border: 2px solid #444;
            max-height: 400px;
            overflow-y: auto;
        }

        .response-box pre {
            color: #4caf50;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .map-container {
            background: #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }

        #map, #displayMap {
            width: 100%;
            height: 500px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .success {
            color: #4caf50;
        }

        .error {
            color: #f44336;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            overflow-y: auto;
        }

        .modal-content {
            background: #2c2c2c;
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            border: 3px solid #ff6b00;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #ff6b00;
            font-size: 20px;
        }

        .close-modal {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .user-info-box {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #4caf50;
        }

        .user-info-box h4 {
            color: #4caf50;
            margin-bottom: 10px;
        }

        .user-info-item {
            color: #ccc;
            font-size: 13px;
            margin: 5px 0;
        }

        .user-info-item strong {
            color: #ff6b00;
        }

        .auth-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .auth-status.logged-in {
            background: #4caf50;
            color: white;
        }

        .auth-status.logged-out {
            background: #d32f2f;
            color: white;
        }

        .poi-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #ff6b00;
            cursor: pointer;
            transition: all 0.3s;
        }

        .poi-card:hover {
            background: #333;
            transform: translateX(5px);
        }

        .poi-card h4 {
            color: #ff6b00;
            margin-bottom: 10px;
        }

        .poi-card .location {
            color: #999;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .poi-card .description {
            color: #ccc;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .poi-type-badge {
            display: inline-block;
            padding: 5px 10px;
            background: #ff6b00;
            color: white;
            border-radius: 5px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 5px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .image-upload-area {
            background: #1a1a1a;
            border: 2px dashed #ff6b00;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload-area:hover {
            background: #2a2a2a;
            border-color: #ff8c00;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin: 10px;
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Test API POI - DabApp</h1>
            <p>Complete testing interface for Points of Interest with authentication</p>
            <div id="authStatus"></div>
        </div>

        <!-- Configuration -->
        <div class="section">
            <h2>‚öôÔ∏è API Configuration</h2>
            <div id="userInfoContainer"></div>
            <div class="grid-2">
                <div class="form-group">
                    <label>API URL</label>
                    <input type="text" id="apiUrl" value="https://be.dabapp.co/api" readonly>
                </div>
                <div class="form-group">
                    <label>Authentication Token</label>
                    <input type="text" id="authToken" placeholder="Click Login to get token" readonly>
                </div>
            </div>
            <button class="btn btn-success" onclick="showLoginModal()">üîê Login</button>
            <button class="btn btn-danger" onclick="logout()" id="logoutBtn" style="display: none;">üö™ Logout</button>
        </div>

        <!-- Interactive Map for POI Selection -->
        <div class="section" id="mapSection" style="display: none;">
            <h2>üó∫Ô∏è Step 1: Select POI Location on Map</h2>
            <p style="color: #999; margin-bottom: 15px;">
                Click on the map to select the location for your Point of Interest
            </p>
            <button class="btn" onclick="initMap()">üìç Load Map</button>
            <button class="btn btn-secondary" onclick="clearMarker()">üóëÔ∏è Clear Marker</button>
            <div class="map-container">
                <div id="map"></div>
            </div>
            <div id="selectedLocation" style="background: #1a1a1a; padding: 15px; border-radius: 5px; margin-top: 15px; display: none;">
                <h4 style="color: #ff6b00; margin-bottom: 10px;">üìç Selected Location</h4>
                <p style="color: #ccc; margin: 5px 0;">
                    <strong style="color: #ff6b00;">Address:</strong> <span id="selectedAddress">-</span>
                </p>
                <p style="color: #ccc; margin: 5px 0;">
                    <strong style="color: #ff6b00;">Latitude:</strong> <span id="selectedLat">-</span>
                </p>
                <p style="color: #ccc; margin: 5px 0;">
                    <strong style="color: #ff6b00;">Longitude:</strong> <span id="selectedLng">-</span>
                </p>
            </div>
        </div>

        <!-- Create POI Form -->
        <div class="section" id="createSection" style="display: none;">
            <h2>üéØ Step 2: Create New POI</h2>
            
            <div class="grid-2">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="poiName" placeholder="Gas Station Casablanca Center">
                </div>
                <div class="form-group">
                    <label>POI Type *</label>
                    <select id="poiType">
                        <option value="">Select a type</option>
                        <option value="1">‚õΩ Gas Station</option>
                        <option value="2">üîß Repair Shop</option>
                        <option value="3">üè™ Moto Store</option>
                        <option value="4">üè® Accommodation</option>
                        <option value="5">üçΩÔ∏è Restaurant</option>
                        <option value="6">üåÑ Viewpoint</option>
                        <option value="7">üèõÔ∏è Tourist Attraction</option>
                        <option value="8">üÖøÔ∏è Parking</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea id="poiDescription" rows="4" placeholder="Describe this point of interest..."></textarea>
            </div>

            <div class="grid-3">
                <div class="form-group">
                    <label>Latitude *</label>
                    <input type="number" id="poiLatitude" step="0.000001" placeholder="33.5731" readonly>
                </div>
                <div class="form-group">
                    <label>Longitude *</label>
                    <input type="number" id="poiLongitude" step="0.000001" placeholder="-7.5898" readonly>
                </div>
                <div class="form-group">
                    <label>Country ID</label>
                    <input type="number" id="poiCountryId" placeholder="1 (Morocco)">
                </div>
            </div>

            <div class="form-group">
                <label>Address</label>
                <input type="text" id="poiAddress" placeholder="123 Main Street, Casablanca">
            </div>

            <div class="grid-3">
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" id="poiPhone" placeholder="+212 5XX XX XX XX">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="poiEmail" placeholder="contact@poi.com">
                </div>
                <div class="form-group">
                    <label>Website</label>
                    <input type="url" id="poiWebsite" placeholder="https://www.poi.com">
                </div>
            </div>

            <div class="form-group">
                <label>Opening Hours (JSON format)</label>
                <textarea id="poiOpeningHours" rows="3" placeholder='{"monday": "08:00-18:00", "tuesday": "08:00-18:00"}'></textarea>
            </div>

            <button class="btn" onclick="createPOI()">üöÄ Create POI</button>
            <div class="response-box" id="createResponse"></div>
        </div>

        <!-- List All POIs -->
        <div class="section" id="listSection" style="display: none;">
            <h2>üìã List All POIs</h2>
            <div class="grid-3">
                <div class="form-group">
                    <label>Filter by Type ID</label>
                    <input type="number" id="filterTypeId" placeholder="Leave empty for all">
                </div>
                <div class="form-group">
                    <label>Latitude (for nearby)</label>
                    <input type="number" id="filterLatitude" step="0.000001" placeholder="33.5731">
                </div>
                <div class="form-group">
                    <label>Longitude (for nearby)</label>
                    <input type="number" id="filterLongitude" step="0.000001" placeholder="-7.5898">
                </div>
            </div>
            <div class="form-group">
                <label>Radius (km)</label>
                <input type="number" id="filterRadius" placeholder="10" value="10">
            </div>
            <button class="btn" onclick="listPOIs()">üìã Get All POIs</button>
            <button class="btn btn-secondary" onclick="listNearbyPOIs()">üìç Get Nearby POIs</button>
            <div class="response-box" id="listResponse"></div>
            <div id="poisList" style="margin-top: 20px;"></div>
        </div>

        <!-- Get POI by ID + Display on Map -->
        <div class="section" id="showSection" style="display: none;">
            <h2>üîç Get POI Details & Display on Map</h2>
            <div class="form-group">
                <label>POI ID</label>
                <input type="number" id="showPoiId" placeholder="1">
            </div>
            <button class="btn" onclick="showPOI()">üîç Get POI Details</button>
            <button class="btn btn-secondary" onclick="displayPOIOnMap()">üó∫Ô∏è Display on Map</button>
            <div class="response-box" id="showResponse"></div>
            <div class="map-container">
                <div id="displayMap"></div>
            </div>
        </div>

        <!-- Update POI -->
        <div class="section" id="updateSection" style="display: none;">
            <h2>‚úèÔ∏è Update POI</h2>
            <div class="form-group">
                <label>POI ID *</label>
                <input type="number" id="updatePoiId" placeholder="1">
            </div>
            <button class="btn btn-secondary" onclick="loadPOIForUpdate()">üì• Load POI Data</button>
            
            <div id="updateForm" style="display: none; margin-top: 20px;">
                <div class="grid-2">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="updatePoiName">
                    </div>
                    <div class="form-group">
                        <label>Type ID</label>
                        <input type="number" id="updatePoiType">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="updatePoiDescription" rows="4"></textarea>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="text" id="updatePoiPhone">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="updatePoiEmail">
                    </div>
                </div>

                <button class="btn" onclick="updatePOI()">üíæ Update POI</button>
            </div>
            
            <div class="response-box" id="updateResponse"></div>
        </div>

        <!-- Delete POI -->
        <div class="section" id="deleteSection" style="display: none;">
            <h2>üóëÔ∏è Delete POI</h2>
            <div class="form-group">
                <label>POI ID</label>
                <input type="number" id="deletePoiId" placeholder="1">
            </div>
            <button class="btn btn-danger" onclick="deletePOI()">üóëÔ∏è Delete POI</button>
            <div class="response-box" id="deleteResponse"></div>
        </div>

        <!-- Toggle Favorite -->
        <div class="section" id="favoriteSection" style="display: none;">
            <h2>‚≠ê Toggle Favorite</h2>
            <div class="form-group">
                <label>POI ID</label>
                <input type="number" id="favoritePoiId" placeholder="1">
            </div>
            <button class="btn" onclick="toggleFavorite()">‚≠ê Toggle Favorite</button>
            <div class="response-box" id="favoriteResponse"></div>
        </div>

        <!-- Get Favorites -->
        <div class="section" id="favoritesListSection" style="display: none;">
            <h2>‚≠ê My Favorite POIs</h2>
            <div class="form-group">
                <label>Filter by Type ID (optional)</label>
                <input type="number" id="favoritesTypeId" placeholder="Leave empty for all">
            </div>
            <button class="btn" onclick="getFavorites()">‚≠ê Get My Favorites</button>
            <div class="response-box" id="favoritesListResponse"></div>
            <div id="favoritesList" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîê Login to DabApp</h3>
                <button class="close-modal" onclick="closeLoginModal()">‚úï</button>
            </div>

            <div class="form-group">
                <label>Email or Phone *</label>
                <input type="text" id="loginInput" placeholder="john.doe@example.com or +212688808238">
            </div>

            <div class="form-group">
                <label>Password *</label>
                <input type="password" id="passwordInput" placeholder="Your password">
            </div>

            <button class="btn btn-success" style="width: 100%;" onclick="performLogin()">
                üöÄ Login
            </button>

            <div class="response-box" id="loginResponse" style="display: none;"></div>
        </div>
    </div>

<script>
    // ===== AUTHENTICATION SYSTEM =====
    let currentUser = null;
    let authToken = null;

    function checkAuth() {
        const storedToken = localStorage.getItem('dabapp_token');
        const storedUser = localStorage.getItem('dabapp_user');

        if (storedToken && storedUser) {
            authToken = storedToken;
            currentUser = JSON.parse(storedUser);
            document.getElementById('authToken').value = authToken;
            updateAuthUI();
        } else {
            updateAuthStatus(false);
        }
    }

    function showLoginModal() {
        document.getElementById('loginModal').style.display = 'block';
    }

    function closeLoginModal() {
        document.getElementById('loginModal').style.display = 'none';
        document.getElementById('loginResponse').style.display = 'none';
    }

    async function performLogin() {
        const login = document.getElementById('loginInput').value;
        const password = document.getElementById('passwordInput').value;
        const responseBox = document.getElementById('loginResponse');

        if (!login || !password) {
            responseBox.style.display = 'block';
            responseBox.innerHTML = '<pre class="error">‚ùå Please enter login and password!</pre>';
            return;
        }

        responseBox.style.display = 'block';
        responseBox.innerHTML = '<pre>üîÑ Authenticating...</pre>';

        try {
            const response = await fetch('https://be.dabapp.co/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    login: login,
                    password: password
                })
            });

            const result = await response.json();

            if (result.user && result.token) {
                currentUser = result.user;
                authToken = result.token;

                localStorage.setItem('dabapp_token', authToken);
                localStorage.setItem('dabapp_user', JSON.stringify(currentUser));

                document.getElementById('authToken').value = authToken;

                responseBox.innerHTML = '<pre class="success">‚úÖ Login successful!<br><br>' + JSON.stringify(result, null, 2) + '</pre>';

                setTimeout(() => {
                    closeLoginModal();
                    updateAuthUI();
                }, 2000);

            } else {
                responseBox.innerHTML = '<pre class="error">‚ùå Login failed!<br><br>' + JSON.stringify(result, null, 2) + '</pre>';
            }
        } catch (error) {
            responseBox.innerHTML = '<pre class="error">‚ùå Error: ' + error.message + '</pre>';
        }
    }

    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('dabapp_token');
            localStorage.removeItem('dabapp_user');
            currentUser = null;
            authToken = null;
            document.getElementById('authToken').value = '';
            updateAuthUI();
            location.reload();
        }
    }

    function updateAuthUI() {
        if (currentUser && authToken) {
            updateAuthStatus(true);
            showUserInfo();
            enableAllSections();
            document.getElementById('logoutBtn').style.display = 'inline-block';
        } else {
            updateAuthStatus(false);
            hideUserInfo();
            disableAllSections();
            document.getElementById('logoutBtn').style.display = 'none';
        }
    }

    function updateAuthStatus(isLoggedIn) {
        const statusDiv = document.getElementById('authStatus');
        if (isLoggedIn) {
            statusDiv.innerHTML = `
                <span class="auth-status logged-in">
                    ‚úÖ Authenticated as ${currentUser.first_name} ${currentUser.last_name}
                </span>
            `;
        } else {
            statusDiv.innerHTML = `
                <span class="auth-status logged-out">
                    ‚ö†Ô∏è Not Authenticated - Please Login
                </span>
            `;
        }
    }

    function showUserInfo() {
        const container = document.getElementById('userInfoContainer');
        container.innerHTML = `
            <div class="user-info-box">
                <h4>üë§ User Information</h4>
                <div class="user-info-item"><strong>Name:</strong> ${currentUser.first_name} ${currentUser.last_name}</div>
                <div class="user-info-item"><strong>Email:</strong> ${currentUser.email}</div>
                <div class="user-info-item"><strong>Role ID:</strong> ${currentUser.role_id}</div>
            </div>
        `;
    }

    function hideUserInfo() {
        document.getElementById('userInfoContainer').innerHTML = '';
    }

    function enableAllSections() {
        const sections = [
            'mapSection', 'createSection', 'listSection', 'showSection',
            'updateSection', 'deleteSection', 'favoriteSection', 'favoritesListSection'
        ];
        sections.forEach(id => {
            document.getElementById(id).style.display = 'block';
        });
    }

    function disableAllSections() {
        const sections = [
            'mapSection', 'createSection', 'listSection', 'showSection',
            'updateSection', 'deleteSection', 'favoriteSection', 'favoritesListSection'
        ];
        sections.forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
    }

    // ===== MAP FUNCTIONS =====
    const GOOGLE_MAPS_API_KEY = 'AIzaSyBznLyPEvm9nm3LerujutDMx1F6zNSpk2E';
    let map;
    let displayMap;
    let marker = null;
    let displayMarker = null;

    const mapStyles = [
        {"featureType": "all", "elementType": "geometry", "stylers": [{"color": "#242f3e"}]},
        {"featureType": "road", "elementType": "geometry.fill", "stylers": [{"color": "#2b2b2b"}]},
        {"featureType": "road", "elementType": "labels.text.fill", "stylers": [{"color": "#ff6b00"}]},
        {"featureType": "road.highway", "elementType": "geometry.stroke", "stylers": [{"color": "#ff6b00"}]},
        {"featureType": "water", "elementType": "geometry", "stylers": [{"color": "#17263c"}]}
    ];

    function getHeaders() {
        return {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'Authorization': authToken ? `Bearer ${authToken}` : ''
        };
    }

    function getApiUrl() {
        return document.getElementById('apiUrl').value;
    }

    function initMap() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        if (!window.google) {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places,geometry`;
            script.onload = () => {
                setupMaps();
                getUserLocation();
            };
            document.head.appendChild(script);
        } else {
            setupMaps();
            getUserLocation();
        }
    }

    function setupMaps() {
        const center = { lat: 33.5731, lng: -7.5898 }; // Casablanca

        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,
            center: center,
            styles: mapStyles,
            mapTypeControl: false,
            streetViewControl: false
        });

        displayMap = new google.maps.Map(document.getElementById('displayMap'), {
            zoom: 12,
            center: center,
            styles: mapStyles,
            mapTypeControl: false,
            streetViewControl: false
        });

        map.addListener('click', function(event) {
            selectLocation(event.latLng);
        });
    }

    function getUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const userPos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map.setCenter(userPos);
                    displayMap.setCenter(userPos);
                },
                function(error) {
                    console.warn('Geolocation disabled:', error);
                }
            );
        }
    }

    function selectLocation(location) {
        const position = {
            lat: location.lat(),
            lng: location.lng()
        };

        if (marker) {
            marker.setMap(null);
        }

        marker = new google.maps.Marker({
            position: position,
            map: map,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 12,
                fillColor: '#ff6b00',
                fillOpacity: 1,
                strokeColor: '#fff',
                strokeWeight: 2
            }
        });

        document.getElementById('poiLatitude').value = position.lat.toFixed(6);
        document.getElementById('poiLongitude').value = position.lng.toFixed(6);

        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ location: position }, function(results, status) {
            if (status === 'OK' && results[0]) {
                document.getElementById('poiAddress').value = results[0].formatted_address;
                
                document.getElementById('selectedLocation').style.display = 'block';
                document.getElementById('selectedAddress').textContent = results[0].formatted_address;
                document.getElementById('selectedLat').textContent = position.lat.toFixed(6);
                document.getElementById('selectedLng').textContent = position.lng.toFixed(6);
            }
        });
    }

    function clearMarker() {
        if (marker) {
            marker.setMap(null);
            marker = null;
        }
        document.getElementById('poiLatitude').value = '';
        document.getElementById('poiLongitude').value = '';
        document.getElementById('poiAddress').value = '';
        document.getElementById('selectedLocation').style.display = 'none';
    }

    // ===== POI API FUNCTIONS =====
    async function createPOI() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const responseBox = document.getElementById('createResponse');
        
        const name = document.getElementById('poiName').value;
        const type_id = document.getElementById('poiType').value;
        const latitude = document.getElementById('poiLatitude').value;
        const longitude = document.getElementById('poiLongitude').value;

        if (!name || !type_id || !latitude || !longitude) {
            responseBox.innerHTML = '<pre class="error">‚ùå Please fill all required fields (Name, Type, Location)</pre>';
            return;
        }

        const data = {
            name: name,
            description: document.getElementById('poiDescription').value,
            type_id: parseInt(type_id),
            latitude: parseFloat(latitude),
            longitude: parseFloat(longitude),
            address: document.getElementById('poiAddress').value,
            country_id: document.getElementById('poiCountryId').value ? parseInt(document.getElementById('poiCountryId').value) : null,
            phone: document.getElementById('poiPhone').value,
            email: document.getElementById('poiEmail').value,
            website: document.getElementById('poiWebsite').value,
        };

        // Parse opening hours if provided
        const openingHours = document.getElementById('poiOpeningHours').value;
        if (openingHours) {
            try {
                data.opening_hours = JSON.parse(openingHours);
            } catch (e) {
                responseBox.innerHTML = '<pre class="error">‚ùå Invalid JSON format for opening hours</pre>';
                return;
            }
        }

        responseBox.innerHTML = '<pre>üîÑ Creating POI...</pre>';

        try {
            const response = await fetch(`${getApiUrl()}/pois`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify(data)
            });

            const result = await response.json();
            responseBox.innerHTML = `<pre class="${result.success ? 'success' : 'error'}">${JSON.stringify(result, null, 2)}</pre>`;

            if (result.success && result.data) {
                document.getElementById('showPoiId').value = result.data.id;
                document.getElementById('updatePoiId').value = result.data.id;
                document.getElementById('deletePoiId').value = result.data.id;
                document.getElementById('favoritePoiId').value = result.data.id;
            }
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    async function listPOIs() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const responseBox = document.getElementById('listResponse');
        responseBox.innerHTML = '<pre>üîÑ Loading POIs...</pre>';

        let url = `${getApiUrl()}/pois`;
        const params = new URLSearchParams();

        const typeId = document.getElementById('filterTypeId').value;
        if (typeId) {
            params.append('type_id', typeId);
        }

        if (params.toString()) {
            url += '?' + params.toString();
        }

        try {
            const response = await fetch(url, {
                headers: getHeaders()
            });
            const result = await response.json();
            responseBox.innerHTML = `<pre class="success">${JSON.stringify(result, null, 2)}</pre>`;

            if (result.success && result.data && result.data.data) {
                displayPOIsList(result.data.data);
            }
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    async function listNearbyPOIs() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const responseBox = document.getElementById('listResponse');
        const latitude = document.getElementById('filterLatitude').value;
        const longitude = document.getElementById('filterLongitude').value;
        const radius = document.getElementById('filterRadius').value;

        if (!latitude || !longitude) {
            responseBox.innerHTML = '<pre class="error">‚ùå Please enter latitude and longitude</pre>';
            return;
        }

        responseBox.innerHTML = '<pre>üîÑ Loading nearby POIs...</pre>';

        const params = new URLSearchParams({
            latitude: latitude,
            longitude: longitude,
            radius: radius || 10
        });

        const typeId = document.getElementById('filterTypeId').value;
        if (typeId) {
            params.append('type_id', typeId);
        }

        try {
            const response = await fetch(`${getApiUrl()}/pois?${params.toString()}`, {
                headers: getHeaders()
            });
            const result = await response.json();
            responseBox.innerHTML = `<pre class="success">${JSON.stringify(result, null, 2)}</pre>`;

            if (result.success && result.data && result.data.data) {
                displayPOIsList(result.data.data);
            }
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    function displayPOIsList(pois) {
        const listDiv = document.getElementById('poisList');
        
        if (!pois || pois.length === 0) {
            listDiv.innerHTML = '<p style="color: #999;">No POIs found</p>';
            return;
        }

        let html = '<h3 style="color: #ff6b00; margin-bottom: 15px;">Found ' + pois.length + ' POI(s)</h3>';
        
        pois.forEach(poi => {
            const typeName = poi.type ? poi.type.name : 'Unknown';
            const verified = poi.is_verified ? '‚úÖ Verified' : '‚ö†Ô∏è Not Verified';
            
            html += `
                <div class="poi-card" onclick="showPOIById(${poi.id})">
                    <h4>${poi.name}</h4>
                    <div style="margin-bottom: 10px;">
                        <span class="poi-type-badge">${typeName}</span>
                        <span style="color: ${poi.is_verified ? '#4caf50' : '#ff9800'}; font-size: 12px;">${verified}</span>
                    </div>
                    <p class="description">${poi.description || 'No description'}</p>
                    <p class="location">üìç ${poi.address || 'No address'}</p>
                    <p class="location">üåç Lat: ${poi.latitude}, Lng: ${poi.longitude}</p>
                    ${poi.phone ? `<p style="color: #ccc; font-size: 13px;">üìû ${poi.phone}</p>` : ''}
                    ${poi.views_count ? `<p style="color: #999; font-size: 12px; margin-top: 5px;">üëÅÔ∏è ${poi.views_count} views</p>` : ''}
                </div>
            `;
        });

        listDiv.innerHTML = html;
    }

    function showPOIById(id) {
        document.getElementById('showPoiId').value = id;
        showPOI();
        window.scrollTo({ top: document.getElementById('showSection').offsetTop - 20, behavior: 'smooth' });
    }

    async function showPOI() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const poiId = document.getElementById('showPoiId').value;
        const responseBox = document.getElementById('showResponse');

        if (!poiId) {
            responseBox.innerHTML = '<pre class="error">‚ùå Please enter a POI ID</pre>';
            return;
        }

        responseBox.innerHTML = '<pre>üîÑ Loading POI...</pre>';

        try {
            const response = await fetch(`${getApiUrl()}/pois/${poiId}`, {
                headers: getHeaders()
            });
            const result = await response.json();
            responseBox.innerHTML = `<pre class="${result.success ? 'success' : 'error'}">${JSON.stringify(result, null, 2)}</pre>`;
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    async function displayPOIOnMap() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const poiId = document.getElementById('showPoiId').value;

        if (!poiId) {
            alert('‚ùå Please enter a POI ID');
            return;
        }

        try {
            const response = await fetch(`${getApiUrl()}/pois/${poiId}`, {
                headers: getHeaders()
            });
            const result = await response.json();

            if (result.success && result.data) {
                const poi = result.data;
                const position = {
                    lat: parseFloat(poi.latitude),
                    lng: parseFloat(poi.longitude)
                };

                if (displayMarker) {
                    displayMarker.setMap(null);
                }

                displayMarker = new google.maps.Marker({
                    position: position,
                    map: displayMap,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 15,
                        fillColor: '#ff6b00',
                        fillOpacity: 1,
                        strokeColor: '#fff',
                        strokeWeight: 3
                    }
                });

                const infoContent = `
                    <div style="color: #000; padding: 10px; max-width: 300px;">
                        <h3 style="margin: 0 0 10px 0;">${poi.name}</h3>
                        <p><strong>Type:</strong> ${poi.type ? poi.type.name : 'N/A'}</p>
                        <p><strong>Address:</strong> ${poi.address || 'N/A'}</p>
                        ${poi.phone ? `<p><strong>Phone:</strong> ${poi.phone}</p>` : ''}
                        ${poi.description ? `<p style="margin-top: 10px;">${poi.description}</p>` : ''}
                    </div>
                `;

                const infowindow = new google.maps.InfoWindow({
                    content: infoContent
                });

                infowindow.open(displayMap, displayMarker);

                displayMap.setCenter(position);
                displayMap.setZoom(15);
            }
        } catch (error) {
            alert('‚ùå Error: ' + error.message);
        }
    }

    async function loadPOIForUpdate() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const poiId = document.getElementById('updatePoiId').value;
        const responseBox = document.getElementById('updateResponse');

        if (!poiId) {
            responseBox.innerHTML = '<pre class="error">‚ùå Please enter a POI ID</pre>';
            return;
        }

        responseBox.innerHTML = '<pre>üîÑ Loading POI data...</pre>';

        try {
            const response = await fetch(`${getApiUrl()}/pois/${poiId}`, {
                headers: getHeaders()
            });
            const result = await response.json();

            if (result.success && result.data) {
                const poi = result.data;
                document.getElementById('updatePoiName').value = poi.name;
                document.getElementById('updatePoiType').value = poi.type_id;
                document.getElementById('updatePoiDescription').value = poi.description || '';
                document.getElementById('updatePoiPhone').value = poi.phone || '';
                document.getElementById('updatePoiEmail').value = poi.email || '';

                document.getElementById('updateForm').style.display = 'block';
                responseBox.innerHTML = '<pre class="success">‚úÖ POI data loaded successfully</pre>';
            } else {
                responseBox.innerHTML = `<pre class="error">${JSON.stringify(result, null, 2)}</pre>`;
            }
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    async function updatePOI() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const poiId = document.getElementById('updatePoiId').value;
        const responseBox = document.getElementById('updateResponse');

        if (!poiId) {
            responseBox.innerHTML = '<pre class="error">‚ùå Please enter a POI ID</pre>';
            return;
        }

        const data = {
            name: document.getElementById('updatePoiName').value,
            type_id: parseInt(document.getElementById('updatePoiType').value),
            description: document.getElementById('updatePoiDescription').value,
            phone: document.getElementById('updatePoiPhone').value,
            email: document.getElementById('updatePoiEmail').value,
        };

        responseBox.innerHTML = '<pre>üîÑ Updating POI...</pre>';

        try {
            const response = await fetch(`${getApiUrl()}/pois/${poiId}`, {
                method: 'PUT',
                headers: getHeaders(),
                body: JSON.stringify(data)
            });
            const result = await response.json();
            responseBox.innerHTML = `<pre class="${result.success ? 'success' : 'error'}">${JSON.stringify(result, null, 2)}</pre>`;
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    async function deletePOI() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const poiId = document.getElementById('deletePoiId').value;
        const responseBox = document.getElementById('deleteResponse');

        if (!poiId) {
            responseBox.innerHTML = '<pre class="error">‚ùå Please enter a POI ID</pre>';
            return;
        }

        if (!confirm('‚ö†Ô∏è Are you sure you want to delete this POI?')) {
            return;
        }

        responseBox.innerHTML = '<pre>üîÑ Deleting POI...</pre>';

        try {
            const response = await fetch(`${getApiUrl()}/pois/${poiId}`, {
                method: 'DELETE',
                headers: getHeaders()
            });
            const result = await response.json();
            responseBox.innerHTML = `<pre class="${result.success ? 'success' : 'error'}">${JSON.stringify(result, null, 2)}</pre>`;
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    async function toggleFavorite() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const poiId = document.getElementById('favoritePoiId').value;
        const responseBox = document.getElementById('favoriteResponse');

        if (!poiId) {
            responseBox.innerHTML = '<pre class="error">‚ùå Please enter a POI ID</pre>';
            return;
        }

        responseBox.innerHTML = '<pre>üîÑ Toggling favorite...</pre>';

        try {
            const response = await fetch(`${getApiUrl()}/pois/${poiId}/favorite`, {
                method: 'POST',
                headers: getHeaders()
            });
            const result = await response.json();
            responseBox.innerHTML = `<pre class="${result.success ? 'success' : 'error'}">${JSON.stringify(result, null, 2)}</pre>`;
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    async function getFavorites() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const responseBox = document.getElementById('favoritesListResponse');
        responseBox.innerHTML = '<pre>üîÑ Loading favorites...</pre>';

        let url = `${getApiUrl()}/pois/favorites`;
        const params = new URLSearchParams();

        const typeId = document.getElementById('favoritesTypeId').value;
        if (typeId) {
            params.append('type_id', typeId);
        }

        if (params.toString()) {
            url += '?' + params.toString();
        }

        try {
            const response = await fetch(url, {
                headers: getHeaders()
            });
            const result = await response.json();
            responseBox.innerHTML = `<pre class="success">${JSON.stringify(result, null, 2)}</pre>`;

            if (result.success && result.data && result.data.data) {
                displayFavoritesList(result.data.data);
            }
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    function displayFavoritesList(pois) {
        const listDiv = document.getElementById('favoritesList');
        
        if (!pois || pois.length === 0) {
            listDiv.innerHTML = '<p style="color: #999;">No favorite POIs found</p>';
            return;
        }

        let html = '<h3 style="color: #ff6b00; margin-bottom: 15px;">‚≠ê ' + pois.length + ' Favorite POI(s)</h3>';
        
        pois.forEach(poi => {
            const typeName = poi.type ? poi.type.name : 'Unknown';
            
            html += `
                <div class="poi-card">
                    <h4>‚≠ê ${poi.name}</h4>
                    <div style="margin-bottom: 10px;">
                        <span class="poi-type-badge">${typeName}</span>
                    </div>
                    <p class="description">${poi.description || 'No description'}</p>
                    <p class="location">üìç ${poi.address || 'No address'}</p>
                    <p class="location">üåç Lat: ${poi.latitude}, Lng: ${poi.longitude}</p>
                </div>
            `;
        });

        listDiv.innerHTML = html;
    }

    // Modal click outside to close
    window.onclick = function(event) {
        const loginModal = document.getElementById('loginModal');
        if (event.target === loginModal) {
            closeLoginModal();
        }
    }

    // Initialize on page load
    window.onload = function() {
        checkAuth();
    };
</script>
</body>
</html>

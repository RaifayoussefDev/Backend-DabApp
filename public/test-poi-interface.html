<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API POI - Enhanced with Search & Dynamic Types</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(90deg, #ff6b00 0%, #cc5500 100%);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            text-transform: uppercase;
        }

        .section {
            background: #2c2c2c;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #ff6b00;
        }

        .section h2 {
            color: #ff6b00;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: #ff6b00;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 13px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 5px;
            color: #fff;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ff6b00;
        }

        .form-group input[readonly] {
            background: #333;
            cursor: not-allowed;
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(90deg, #ff6b00 0%, #cc5500 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            text-transform: uppercase;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #555;
        }

        .btn-danger {
            background: #d32f2f;
        }

        .btn-success {
            background: #4caf50;
        }

        .response-box {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border: 2px solid #444;
            max-height: 400px;
            overflow-y: auto;
        }

        .response-box pre {
            color: #4caf50;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .map-container {
            background: #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
            position: relative;
        }

        #map, #displayMap {
            width: 100%;
            height: 600px;
        }

        /* Search Box Styling */
        .search-box-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 500px;
        }

        #searchBox {
            width: 100%;
            padding: 15px 20px;
            font-size: 16px;
            border: 3px solid #ff6b00;
            border-radius: 10px;
            background: white;
            color: #000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

        #searchBox:focus {
            outline: none;
            border-color: #ff8c00;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .success {
            color: #4caf50;
        }

        .error {
            color: #f44336;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            overflow-y: auto;
        }

        .modal-content {
            background: #2c2c2c;
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            border: 3px solid #ff6b00;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #ff6b00;
            font-size: 20px;
        }

        .close-modal {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .user-info-box {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #4caf50;
        }

        .user-info-box h4 {
            color: #4caf50;
            margin-bottom: 10px;
        }

        .user-info-item {
            color: #ccc;
            font-size: 13px;
            margin: 5px 0;
        }

        .user-info-item strong {
            color: #ff6b00;
        }

        .auth-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .auth-status.logged-in {
            background: #4caf50;
            color: white;
        }

        .auth-status.logged-out {
            background: #d32f2f;
            color: white;
        }

        .place-info-box {
            background: linear-gradient(135deg, #1a3a1a 0%, #2c4c2c 100%);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            border: 3px solid #4caf50;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .place-info-box h4 {
            color: #4caf50;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .rating-stars {
            color: #ffc107;
            font-size: 20px;
            margin: 10px 0;
        }

        .place-detail {
            color: #ccc;
            font-size: 13px;
            margin: 8px 0;
            padding: 8px;
            background: #1a1a1a;
            border-radius: 5px;
        }

        .place-detail strong {
            color: #4caf50;
            display: inline-block;
            min-width: 120px;
        }

        .info-note {
            background: #1a3a5a;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }

        .info-note p {
            color: #90caf9;
            font-size: 13px;
            margin: 5px 0;
        }

        .use-place-data-btn {
            background: linear-gradient(90deg, #4caf50 0%, #388e3c 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            text-transform: uppercase;
            margin-top: 15px;
            width: 100%;
        }

        .use-place-data-btn:hover {
            opacity: 0.9;
        }

        .poi-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #ff6b00;
            cursor: pointer;
            transition: all 0.3s;
        }

        .poi-card:hover {
            background: #333;
            transform: translateX(5px);
        }

        .poi-type-badge {
            display: inline-block;
            padding: 5px 10px;
            background: #ff6b00;
            color: white;
            border-radius: 5px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 5px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }

            .search-box-container {
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Test API POI - Recherche Google Maps Int√©gr√©e</h1>
            <p>Recherchez et cliquez sur n'importe quel lieu Google Maps!</p>
            <div id="authStatus"></div>
        </div>

        <!-- Configuration -->
        <div class="section">
            <h2>‚öôÔ∏è API Configuration</h2>
            <div id="userInfoContainer"></div>
            <div class="grid-2">
                <div class="form-group">
                    <label>API URL</label>
                    <input type="text" id="apiUrl" value="https://be.dabapp.co/api" readonly>
                </div>
                <div class="form-group">
                    <label>Authentication Token</label>
                    <input type="text" id="authToken" placeholder="Click Login to get token" readonly>
                </div>
            </div>
            <button class="btn btn-success" onclick="showLoginModal()">üîê Login</button>
            <button class="btn btn-danger" onclick="logout()" id="logoutBtn" style="display: none;">üö™ Logout</button>
        </div>

        <!-- Interactive Map with Search -->
        <div class="section" id="mapSection" style="display: none;">
            <h2>üó∫Ô∏è Recherche de Lieux Google Maps</h2>

            <div class="info-note">
                <p><strong>üí° Comment utiliser:</strong></p>
                <p>‚Ä¢ <strong>Tapez dans la barre de recherche</strong> sur la carte (ex: "Station Total Casablanca", "Restaurant", "Ferme √âquestre")</p>
                <p>‚Ä¢ <strong>S√©lectionnez un lieu</strong> dans les suggestions ‚Üí Un marqueur appara√Æt automatiquement</p>
                <p>‚Ä¢ <strong>Cliquez sur le marqueur</strong> pour r√©cup√©rer TOUTES les informations (nom, adresse, t√©l√©phone, site, rating, avis, photos, horaires)</p>
                <p>‚Ä¢ Les informations sont automatiquement pr√©-remplies dans le formulaire ci-dessous ‚ú®</p>
                <p>‚Ä¢ Vous pouvez aussi <strong>cliquer directement sur n'importe quel lieu visible</strong> sur la carte!</p>
            </div>

            <button class="btn" onclick="initMap()">üìç Load Map with Search</button>
            <button class="btn btn-secondary" onclick="clearMarker()">üóëÔ∏è Clear Selection</button>

            <div class="map-container">
                <div class="search-box-container">
                    <input id="searchBox" type="text" placeholder="üîç Recherchez un lieu... (ex: Ferme √âquestre, Station Total, Restaurant...)" />
                </div>
                <div id="map"></div>
            </div>

            <div id="selectedLocation" style="background: #1a1a1a; padding: 15px; border-radius: 5px; margin-top: 15px; display: none;">
                <h4 style="color: #ff6b00; margin-bottom: 10px;">üìç Lieu s√©lectionn√©</h4>
                <p style="color: #ccc; margin: 5px 0;">
                    <strong style="color: #ff6b00;">Latitude:</strong> <span id="selectedLat">-</span>
                </p>
                <p style="color: #ccc; margin: 5px 0;">
                    <strong style="color: #ff6b00;">Longitude:</strong> <span id="selectedLng">-</span>
                </p>
            </div>

            <!-- Google Place Information -->
            <div id="placeInfoBox" style="display: none;"></div>
        </div>

        <!-- Create POI Form -->
        <div class="section" id="createSection" style="display: none;">
            <h2>üéØ Cr√©er un nouveau POI</h2>

            <div class="grid-2">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="poiName" placeholder="Gas Station Casablanca Center">
                </div>
                <div class="form-group">
                    <label>POI Type * (Charg√© depuis l'API)</label>
                    <select id="poiType">
                        <option value="">Chargement...</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea id="poiDescription" rows="4" placeholder="Describe this point of interest..."></textarea>
            </div>

            <div class="grid-3">
                <div class="form-group">
                    <label>Latitude *</label>
                    <input type="number" id="poiLatitude" step="0.000001" placeholder="33.5731" readonly>
                </div>
                <div class="form-group">
                    <label>Longitude *</label>
                    <input type="number" id="poiLongitude" step="0.000001" placeholder="-7.5898" readonly>
                </div>
                <div class="form-group">
                    <label>Country ID</label>
                    <input type="number" id="poiCountryId" placeholder="1 (Morocco)">
                </div>
            </div>

            <div class="form-group">
                <label>Address</label>
                <input type="text" id="poiAddress" placeholder="123 Main Street, Casablanca">
            </div>

            <div class="grid-3">
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" id="poiPhone" placeholder="+212 5XX XX XX XX">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="poiEmail" placeholder="contact@poi.com">
                </div>
                <div class="form-group">
                    <label>Website</label>
                    <input type="url" id="poiWebsite" placeholder="https://www.poi.com">
                </div>
            </div>

            <div class="form-group">
                <label>Opening Hours (JSON format)</label>
                <textarea id="poiOpeningHours" rows="3" placeholder='{"monday": "08:00-18:00", "tuesday": "08:00-18:00"}'></textarea>
            </div>

            <button class="btn" onclick="createPOI()">üöÄ Create POI</button>
            <div class="response-box" id="createResponse"></div>
        </div>

        <!-- Other sections remain the same... -->
        <div class="section" id="listSection" style="display: none;">
            <h2>üìã List All POIs</h2>
            <button class="btn" onclick="listPOIs()">üìã Get All POIs</button>
            <div class="response-box" id="listResponse"></div>
            <div id="poisList" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîê Login to DabApp</h3>
                <button class="close-modal" onclick="closeLoginModal()">‚úï</button>
            </div>

            <div class="form-group">
                <label>Email or Phone *</label>
                <input type="text" id="loginInput" placeholder="john.doe@example.com or +212688808238">
            </div>

            <div class="form-group">
                <label>Password *</label>
                <input type="password" id="passwordInput" placeholder="Your password">
            </div>

            <button class="btn btn-success" style="width: 100%;" onclick="performLogin()">
                üöÄ Login
            </button>

            <div class="response-box" id="loginResponse" style="display: none;"></div>
        </div>
    </div>

<script>
    // ===== GLOBAL VARIABLES =====
    let currentUser = null;
    let authToken = null;
    let map;
    let marker = null;
    let placesService;
    let currentPlaceData = null;
    let poiTypesData = [];
    let searchBox;

    const GOOGLE_MAPS_API_KEY = 'AIzaSyBznLyPEvm9nm3LerujutDMx1F6zNSpk2E';

    const mapStyles = [
        {"featureType": "all", "elementType": "geometry", "stylers": [{"color": "#242f3e"}]},
        {"featureType": "road", "elementType": "geometry.fill", "stylers": [{"color": "#2b2b2b"}]},
        {"featureType": "road", "elementType": "labels.text.fill", "stylers": [{"color": "#ff6b00"}]},
        {"featureType": "road.highway", "elementType": "geometry.stroke", "stylers": [{"color": "#ff6b00"}]},
        {"featureType": "water", "elementType": "geometry", "stylers": [{"color": "#17263c"}]}
    ];

    // ===== AUTHENTICATION =====
    function checkAuth() {
        const storedToken = localStorage.getItem('dabapp_token');
        const storedUser = localStorage.getItem('dabapp_user');

        if (storedToken && storedUser) {
            authToken = storedToken;
            currentUser = JSON.parse(storedUser);
            document.getElementById('authToken').value = authToken;
            updateAuthUI();
        } else {
            updateAuthStatus(false);
        }
    }

    function showLoginModal() {
        document.getElementById('loginModal').style.display = 'block';
    }

    function closeLoginModal() {
        document.getElementById('loginModal').style.display = 'none';
        document.getElementById('loginResponse').style.display = 'none';
    }

    async function performLogin() {
        const login = document.getElementById('loginInput').value;
        const password = document.getElementById('passwordInput').value;
        const responseBox = document.getElementById('loginResponse');

        if (!login || !password) {
            responseBox.style.display = 'block';
            responseBox.innerHTML = '<pre class="error">‚ùå Please enter login and password!</pre>';
            return;
        }

        responseBox.style.display = 'block';
        responseBox.innerHTML = '<pre>üîÑ Authenticating...</pre>';

        try {
            const response = await fetch('https://be.dabapp.co/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ login: login, password: password })
            });

            const result = await response.json();

            if (result.user && result.token) {
                currentUser = result.user;
                authToken = result.token;
                localStorage.setItem('dabapp_token', authToken);
                localStorage.setItem('dabapp_user', JSON.stringify(currentUser));
                document.getElementById('authToken').value = authToken;
                responseBox.innerHTML = '<pre class="success">‚úÖ Login successful!</pre>';

                setTimeout(() => {
                    closeLoginModal();
                    updateAuthUI();
                    loadPOITypes(); // Load POI types after login
                }, 2000);
            } else {
                responseBox.innerHTML = '<pre class="error">‚ùå Login failed!<br><br>' + JSON.stringify(result, null, 2) + '</pre>';
            }
        } catch (error) {
            responseBox.innerHTML = '<pre class="error">‚ùå Error: ' + error.message + '</pre>';
        }
    }

    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('dabapp_token');
            localStorage.removeItem('dabapp_user');
            currentUser = null;
            authToken = null;
            document.getElementById('authToken').value = '';
            updateAuthUI();
            location.reload();
        }
    }

    function updateAuthUI() {
        if (currentUser && authToken) {
            updateAuthStatus(true);
            showUserInfo();
            enableAllSections();
            document.getElementById('logoutBtn').style.display = 'inline-block';
        } else {
            updateAuthStatus(false);
            hideUserInfo();
            disableAllSections();
            document.getElementById('logoutBtn').style.display = 'none';
        }
    }

    function updateAuthStatus(isLoggedIn) {
        const statusDiv = document.getElementById('authStatus');
        if (isLoggedIn) {
            statusDiv.innerHTML = `<span class="auth-status logged-in">‚úÖ Authenticated as ${currentUser.first_name} ${currentUser.last_name}</span>`;
        } else {
            statusDiv.innerHTML = `<span class="auth-status logged-out">‚ö†Ô∏è Not Authenticated - Please Login</span>`;
        }
    }

    function showUserInfo() {
        const container = document.getElementById('userInfoContainer');
        container.innerHTML = `
            <div class="user-info-box">
                <h4>üë§ User Information</h4>
                <div class="user-info-item"><strong>Name:</strong> ${currentUser.first_name} ${currentUser.last_name}</div>
                <div class="user-info-item"><strong>Email:</strong> ${currentUser.email}</div>
                <div class="user-info-item"><strong>Role ID:</strong> ${currentUser.role_id}</div>
            </div>
        `;
    }

    function hideUserInfo() {
        document.getElementById('userInfoContainer').innerHTML = '';
    }

    function enableAllSections() {
        const sections = ['mapSection', 'createSection', 'listSection'];
        sections.forEach(id => document.getElementById(id).style.display = 'block');
    }

    function disableAllSections() {
        const sections = ['mapSection', 'createSection', 'listSection'];
        sections.forEach(id => document.getElementById(id).style.display = 'none');
    }

    // ===== LOAD POI TYPES FROM API =====
    async function loadPOITypes() {
        if (!authToken) return;

        try {
            const response = await fetch('https://be.dabapp.co/api/poi-types', {
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                }
            });

            const result = await response.json();

            if (result.success && result.data) {
                poiTypesData = result.data;
                populatePOITypeSelect();
            }
        } catch (error) {
            console.error('Error loading POI types:', error);
        }
    }

    function populatePOITypeSelect() {
        const select = document.getElementById('poiType');
        select.innerHTML = '<option value="">S√©lectionnez un type</option>';

        poiTypesData.forEach(type => {
            const option = document.createElement('option');
            option.value = type.id;
            option.textContent = `${type.icon || 'üìç'} ${type.name}`;
            option.setAttribute('data-types', JSON.stringify(type));
            select.appendChild(option);
        });
    }

    // ===== GOOGLE MAPS & PLACES =====
    function initMap() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        if (!window.google) {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places,geometry`;
            script.onload = () => {
                setupMap();
                getUserLocation();
            };
            document.head.appendChild(script);
        } else {
            setupMap();
            getUserLocation();
        }
    }

    function setupMap() {
        const center = { lat: 33.5731, lng: -7.5898 };

        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,
            center: center,
            styles: mapStyles,
            mapTypeControl: false,
            streetViewControl: false
        });

        placesService = new google.maps.places.PlacesService(map);

        // Setup Search Box
        const input = document.getElementById('searchBox');
        searchBox = new google.maps.places.SearchBox(input);

        // Bias results to map viewport
        map.addListener('bounds_changed', () => {
            searchBox.setBounds(map.getBounds());
        });

        // Listen for place selection
        searchBox.addListener('places_changed', () => {
            const places = searchBox.getPlaces();

            if (places.length === 0) return;

            // Clear existing marker
            if (marker) {
                marker.setMap(null);
            }

            // Get the first place
            const place = places[0];

            if (!place.geometry || !place.geometry.location) {
                console.log("Place has no geometry");
                return;
            }

            // Create marker
            marker = new google.maps.Marker({
                position: place.geometry.location,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 15,
                    fillColor: '#ff6b00',
                    fillOpacity: 1,
                    strokeColor: '#fff',
                    strokeWeight: 3
                },
                animation: google.maps.Animation.DROP
            });

            // Set coordinates
            const lat = place.geometry.location.lat();
            const lng = place.geometry.location.lng();

            document.getElementById('poiLatitude').value = lat.toFixed(6);
            document.getElementById('poiLongitude').value = lng.toFixed(6);

            document.getElementById('selectedLocation').style.display = 'block';
            document.getElementById('selectedLat').textContent = lat.toFixed(6);
            document.getElementById('selectedLng').textContent = lng.toFixed(6);

            // Get full place details
            if (place.place_id) {
                getPlaceDetails(place.place_id, true);
            }

            // Center and zoom to place
            map.setCenter(place.geometry.location);
            map.setZoom(15);

            // Add click listener to marker
            marker.addListener('click', () => {
                if (place.place_id) {
                    getPlaceDetails(place.place_id, true);
                }
            });
        });

        // Allow clicking on places directly on the map
        map.addListener('click', (event) => {
            selectLocationFromClick(event.latLng);
        });
    }

    function selectLocationFromClick(latLng) {
        // Search for nearby place at click location
        const request = {
            location: latLng,
            radius: 50
        };

        placesService.nearbySearch(request, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                const place = results[0];

                if (marker) {
                    marker.setMap(null);
                }

                marker = new google.maps.Marker({
                    position: place.geometry.location,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 15,
                        fillColor: '#ff6b00',
                        fillOpacity: 1,
                        strokeColor: '#fff',
                        strokeWeight: 3
                    },
                    animation: google.maps.Animation.BOUNCE
                });

                setTimeout(() => marker.setAnimation(null), 2000);

                const lat = place.geometry.location.lat();
                const lng = place.geometry.location.lng();

                document.getElementById('poiLatitude').value = lat.toFixed(6);
                document.getElementById('poiLongitude').value = lng.toFixed(6);

                document.getElementById('selectedLocation').style.display = 'block';
                document.getElementById('selectedLat').textContent = lat.toFixed(6);
                document.getElementById('selectedLng').textContent = lng.toFixed(6);

                getPlaceDetails(place.place_id, true);
            }
        });
    }

    function getUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userPos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map.setCenter(userPos);
                },
                (error) => console.warn('Geolocation disabled:', error)
            );
        }
    }

    function getPlaceDetails(placeId, autoFillForm = false) {
        const request = {
            placeId: placeId,
            fields: [
                'name', 'formatted_address', 'geometry', 'rating', 'user_ratings_total',
                'reviews', 'formatted_phone_number', 'international_phone_number',
                'website', 'opening_hours', 'photos', 'types', 'price_level',
                'business_status', 'url'
            ]
        };

        placesService.getDetails(request, (place, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                currentPlaceData = place;
                displayPlaceInfo(place);

                if (autoFillForm) {
                    usePlaceData();
                    setTimeout(() => {
                        window.scrollTo({
                            top: document.getElementById('createSection').offsetTop - 20,
                            behavior: 'smooth'
                        });
                    }, 500);
                }
            }
        });
    }

    function displayPlaceInfo(place) {
        const infoBox = document.getElementById('placeInfoBox');
        infoBox.style.display = 'block';

        let starsHtml = '';
        if (place.rating) {
            const fullStars = Math.floor(place.rating);
            const hasHalfStar = place.rating % 1 >= 0.5;

            for (let i = 0; i < fullStars; i++) {
                starsHtml += '‚≠ê';
            }
            if (hasHalfStar) {
                starsHtml += '‚ú®';
            }
        }

        infoBox.innerHTML = `
            <div class="place-info-box">
                <h4>üéØ Informations Google Maps r√©cup√©r√©es!</h4>

                <div class="place-detail">
                    <strong>üìç Nom:</strong> ${place.name}
                </div>

                <div class="place-detail">
                    <strong>üìÆ Adresse:</strong> ${place.formatted_address || 'N/A'}
                </div>

                ${place.rating ? `
                    <div class="place-detail">
                        <strong>‚≠ê Note:</strong> ${place.rating} / 5
                        <div class="rating-stars">${starsHtml} (${place.user_ratings_total} avis)</div>
                    </div>
                ` : ''}

                ${place.formatted_phone_number ? `
                    <div class="place-detail">
                        <strong>üìû T√©l√©phone:</strong> ${place.formatted_phone_number}
                    </div>
                ` : ''}

                ${place.website ? `
                    <div class="place-detail">
                        <strong>üåê Site web:</strong> <a href="${place.website}" target="_blank" style="color: #4caf50;">${place.website}</a>
                    </div>
                ` : ''}

                ${place.url ? `
                    <div class="place-detail">
                        <strong>üîó Google Maps:</strong> <a href="${place.url}" target="_blank" style="color: #4caf50;">Voir sur Google Maps</a>
                    </div>
                ` : ''}

                <button class="use-place-data-btn" onclick="usePlaceData()">
                    ‚úÖ Utiliser ces donn√©es pour cr√©er le POI
                </button>
            </div>
        `;
    }

    function usePlaceData() {
        if (!currentPlaceData) return;

        const place = currentPlaceData;

        document.getElementById('poiName').value = place.name || '';
        document.getElementById('poiAddress').value = place.formatted_address || '';
        document.getElementById('poiPhone').value = place.formatted_phone_number || '';
        document.getElementById('poiWebsite').value = place.website || '';

        let description = '';
        if (place.rating) {
            description += `Note Google: ${place.rating}/5 (${place.user_ratings_total} avis)\n\n`;
        }
        if (place.types && place.types.length > 0) {
            description += `Types: ${place.types.slice(0, 5).join(', ')}\n\n`;
        }
        document.getElementById('poiDescription').value = description;

        if (place.opening_hours && place.opening_hours.weekday_text) {
            const openingHoursObj = {};
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            place.opening_hours.weekday_text.forEach((text, index) => {
                openingHoursObj[days[index]] = text.split(': ')[1] || 'Closed';
            });
            document.getElementById('poiOpeningHours').value = JSON.stringify(openingHoursObj, null, 2);
        }

        // Auto-select POI type
        autoSelectPOIType(place.types);

        window.scrollTo({ top: document.getElementById('createSection').offsetTop - 20, behavior: 'smooth' });

        showTemporaryNotification('‚úÖ Donn√©es Google Places charg√©es dans le formulaire!');
    }

    function autoSelectPOIType(googleTypes) {
        if (!googleTypes || !poiTypesData.length) return;

        const typeMapping = {
            'gas_station': ['Gas Station', 'Station Service'],
            'car_repair': ['Repair Shop', 'Garage'],
            'store': ['Store', 'Magasin'],
            'lodging': ['Accommodation', 'H√©bergement'],
            'hotel': ['Accommodation', 'H√¥tel'],
            'restaurant': ['Restaurant'],
            'cafe': ['Restaurant', 'Caf√©'],
            'tourist_attraction': ['Tourist Attraction', 'Attraction'],
            'museum': ['Tourist Attraction', 'Mus√©e'],
            'park': ['Viewpoint', 'Parc'],
            'parking': ['Parking']
        };

        for (const googleType of googleTypes) {
            if (typeMapping[googleType]) {
                const matchingNames = typeMapping[googleType];
                const matchedType = poiTypesData.find(type =>
                    matchingNames.some(name =>
                        type.name.toLowerCase().includes(name.toLowerCase())
                    )
                );

                if (matchedType) {
                    document.getElementById('poiType').value = matchedType.id;
                    break;
                }
            }
        }
    }

    function clearMarker() {
        if (marker) {
            marker.setMap(null);
            marker = null;
        }

        document.getElementById('poiLatitude').value = '';
        document.getElementById('poiLongitude').value = '';
        document.getElementById('poiAddress').value = '';
        document.getElementById('selectedLocation').style.display = 'none';
        document.getElementById('placeInfoBox').style.display = 'none';
        document.getElementById('searchBox').value = '';
        currentPlaceData = null;
    }

    function showTemporaryNotification(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 10000;
            font-weight: bold;
            animation: slideInRight 0.3s ease-out;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // ===== API FUNCTIONS =====
    function getHeaders() {
        return {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'Authorization': authToken ? `Bearer ${authToken}` : ''
        };
    }

    async function createPOI() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const responseBox = document.getElementById('createResponse');

        const name = document.getElementById('poiName').value;
        const type_id = document.getElementById('poiType').value;
        const latitude = document.getElementById('poiLatitude').value;
        const longitude = document.getElementById('poiLongitude').value;

        if (!name || !type_id || !latitude || !longitude) {
            responseBox.innerHTML = '<pre class="error">‚ùå Please fill all required fields (Name, Type, Location)</pre>';
            return;
        }

        const data = {
            name: name,
            description: document.getElementById('poiDescription').value,
            type_id: parseInt(type_id),
            latitude: parseFloat(latitude),
            longitude: parseFloat(longitude),
            address: document.getElementById('poiAddress').value,
            country_id: document.getElementById('poiCountryId').value ? parseInt(document.getElementById('poiCountryId').value) : null,
            phone: document.getElementById('poiPhone').value,
            email: document.getElementById('poiEmail').value,
            website: document.getElementById('poiWebsite').value,
        };

        const openingHours = document.getElementById('poiOpeningHours').value;
        if (openingHours) {
            try {
                data.opening_hours = JSON.parse(openingHours);
            } catch (e) {
                responseBox.innerHTML = '<pre class="error">‚ùå Invalid JSON format for opening hours</pre>';
                return;
            }
        }

        responseBox.innerHTML = '<pre>üîÑ Creating POI...</pre>';

        try {
            const response = await fetch('https://be.dabapp.co/api/pois', {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify(data)
            });

            const result = await response.json();
            responseBox.innerHTML = `<pre class="${result.success ? 'success' : 'error'}">${JSON.stringify(result, null, 2)}</pre>`;

            if (result.success) {
                showTemporaryNotification('‚úÖ POI cr√©√© avec succ√®s!');
            }
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    async function listPOIs() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const responseBox = document.getElementById('listResponse');
        responseBox.innerHTML = '<pre>üîÑ Loading POIs...</pre>';

        try {
            const response = await fetch('https://be.dabapp.co/api/pois', { headers: getHeaders() });
            const result = await response.json();
            responseBox.innerHTML = `<pre class="success">${JSON.stringify(result, null, 2)}</pre>`;

            if (result.success && result.data && result.data.data) {
                displayPOIsList(result.data.data);
            }
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    function displayPOIsList(pois) {
        const listDiv = document.getElementById('poisList');

        if (!pois || pois.length === 0) {
            listDiv.innerHTML = '<p style="color: #999;">No POIs found</p>';
            return;
        }

        let html = '<h3 style="color: #ff6b00; margin-bottom: 15px;">Found ' + pois.length + ' POI(s)</h3>';

        pois.forEach(poi => {
            const typeName = poi.type ? poi.type.name : 'Unknown';

            html += `
                <div class="poi-card">
                    <h4>${poi.name}</h4>
                    <div style="margin-bottom: 10px;">
                        <span class="poi-type-badge">${typeName}</span>
                    </div>
                    <p style="color: #ccc; font-size: 13px;">${poi.description || 'No description'}</p>
                    <p style="color: #999; font-size: 12px;">üìç ${poi.address || 'No address'}</p>
                </div>
            `;
        });

        listDiv.innerHTML = html;
    }

    // Modal click outside to close
    window.onclick = function(event) {
        const loginModal = document.getElementById('loginModal');
        if (event.target === loginModal) {
            closeLoginModal();
        }
    }

    // Initialize on page load
    window.onload = function() {
        checkAuth();
    };
</script>
</body>
</html>

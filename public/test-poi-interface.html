<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API POI - DabApp Style (avec Google Places)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(90deg, #ff6b00 0%, #cc5500 100%);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            text-transform: uppercase;
        }

        .section {
            background: #2c2c2c;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #ff6b00;
        }

        .section h2 {
            color: #ff6b00;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: #ff6b00;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 13px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 5px;
            color: #fff;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ff6b00;
        }

        .form-group input[readonly] {
            background: #333;
            cursor: not-allowed;
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(90deg, #ff6b00 0%, #cc5500 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            text-transform: uppercase;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #555;
        }

        .btn-danger {
            background: #d32f2f;
        }

        .btn-success {
            background: #4caf50;
        }

        .response-box {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border: 2px solid #444;
            max-height: 400px;
            overflow-y: auto;
        }

        .response-box pre {
            color: #4caf50;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .map-container {
            background: #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }

        #map, #displayMap {
            width: 100%;
            height: 500px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .success {
            color: #4caf50;
        }

        .error {
            color: #f44336;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            overflow-y: auto;
        }

        .modal-content {
            background: #2c2c2c;
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            border: 3px solid #ff6b00;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #ff6b00;
            font-size: 20px;
        }

        .close-modal {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .user-info-box {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #4caf50;
        }

        .user-info-box h4 {
            color: #4caf50;
            margin-bottom: 10px;
        }

        .user-info-item {
            color: #ccc;
            font-size: 13px;
            margin: 5px 0;
        }

        .user-info-item strong {
            color: #ff6b00;
        }

        .auth-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .auth-status.logged-in {
            background: #4caf50;
            color: white;
        }

        .auth-status.logged-out {
            background: #d32f2f;
            color: white;
        }

        .poi-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #ff6b00;
            cursor: pointer;
            transition: all 0.3s;
        }

        .poi-card:hover {
            background: #333;
            transform: translateX(5px);
        }

        .poi-card h4 {
            color: #ff6b00;
            margin-bottom: 10px;
        }

        .poi-card .location {
            color: #999;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .poi-card .description {
            color: #ccc;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .poi-type-badge {
            display: inline-block;
            padding: 5px 10px;
            background: #ff6b00;
            color: white;
            border-radius: 5px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 5px;
        }

        .place-info-box {
            background: linear-gradient(135deg, #1a3a1a 0%, #2c4c2c 100%);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            border: 3px solid #4caf50;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .place-info-box h4 {
            color: #4caf50;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rating-stars {
            color: #ffc107;
            font-size: 20px;
            margin: 10px 0;
        }

        .place-detail {
            color: #ccc;
            font-size: 13px;
            margin: 8px 0;
            padding: 8px;
            background: #1a1a1a;
            border-radius: 5px;
        }

        .place-detail strong {
            color: #4caf50;
            display: inline-block;
            min-width: 120px;
        }

        .review-item {
            background: #1a1a1a;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 3px solid #ffc107;
        }

        .review-author {
            color: #ff6b00;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .review-text {
            color: #ccc;
            font-size: 13px;
        }

        .use-place-data-btn {
            background: linear-gradient(90deg, #4caf50 0%, #388e3c 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            text-transform: uppercase;
            margin-top: 15px;
        }

        .use-place-data-btn:hover {
            opacity: 0.9;
        }

        .info-note {
            background: #1a3a5a;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }

        .info-note p {
            color: #90caf9;
            font-size: 13px;
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Test API POI - DabApp (avec Google Places)</h1>
            <p>Complete testing interface with Google Places integration</p>
            <div id="authStatus"></div>
        </div>

        <!-- Configuration -->
        <div class="section">
            <h2>‚öôÔ∏è API Configuration</h2>
            <div id="userInfoContainer"></div>
            <div class="grid-2">
                <div class="form-group">
                    <label>API URL</label>
                    <input type="text" id="apiUrl" value="https://be.dabapp.co/api" readonly>
                </div>
                <div class="form-group">
                    <label>Authentication Token</label>
                    <input type="text" id="authToken" placeholder="Click Login to get token" readonly>
                </div>
            </div>
            <button class="btn btn-success" onclick="showLoginModal()">üîê Login</button>
            <button class="btn btn-danger" onclick="logout()" id="logoutBtn" style="display: none;">üö™ Logout</button>
        </div>

        <!-- Interactive Map for POI Selection with Google Places -->
        <div class="section" id="mapSection" style="display: none;">
            <h2>üó∫Ô∏è Step 1: Select Location & Get Google Places Info</h2>

            <div class="info-note">
                <p><strong>üí° Comment √ßa marche:</strong></p>
                <p>‚Ä¢ <strong>Points verts sur la carte</strong> = Lieux Google Maps existants</p>
                <p>‚Ä¢ <strong>Survolez un point vert</strong> pour voir un aper√ßu (nom, note, type, statut)</p>
                <p>‚Ä¢ <strong>Cliquez sur un point vert</strong> pour r√©cup√©rer toutes les informations d√©taill√©es</p>
                <p>‚Ä¢ Ou cliquez n'importe o√π sur la carte pour cr√©er un nouveau point</p>
                <p>‚Ä¢ Les informations r√©cup√©r√©es incluent: nom, adresse, rating, avis, photos, horaires, t√©l√©phone, site web</p>
                <p>‚Ä¢ Cliquez sur "Utiliser ces donn√©es" pour pr√©-remplir automatiquement le formulaire</p>
            </div>

            <button class="btn" onclick="initMap()">üìç Load Map</button>
            <button class="btn btn-secondary" onclick="showNearbyPlacesAroundCenter()">üîç Show Nearby Places</button>
            <button class="btn btn-secondary" onclick="clearMarker()">üóëÔ∏è Clear Markers</button>

            <div class="map-container">
                <div id="map"></div>
            </div>

            <div id="selectedLocation" style="background: #1a1a1a; padding: 15px; border-radius: 5px; margin-top: 15px; display: none;">
                <h4 style="color: #ff6b00; margin-bottom: 10px;">üìç Coordonn√©es s√©lectionn√©es</h4>
                <p style="color: #ccc; margin: 5px 0;">
                    <strong style="color: #ff6b00;">Latitude:</strong> <span id="selectedLat">-</span>
                </p>
                <p style="color: #ccc; margin: 5px 0;">
                    <strong style="color: #ff6b00;">Longitude:</strong> <span id="selectedLng">-</span>
                </p>
            </div>

            <!-- Google Place Information -->
            <div id="placeInfoBox" style="display: none;"></div>
        </div>

        <!-- Create POI Form -->
        <div class="section" id="createSection" style="display: none;">
            <h2>üéØ Step 2: Create New POI</h2>

            <div class="grid-2">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="poiName" placeholder="Gas Station Casablanca Center">
                </div>
                <div class="form-group">
                    <label>POI Type *</label>
                    <select id="poiType">
                        <option value="">Select a type</option>
                        <option value="1">‚õΩ Gas Station</option>
                        <option value="2">üîß Repair Shop</option>
                        <option value="3">üè™ Moto Store</option>
                        <option value="4">üè® Accommodation</option>
                        <option value="5">üçΩÔ∏è Restaurant</option>
                        <option value="6">üåÑ Viewpoint</option>
                        <option value="7">üèõÔ∏è Tourist Attraction</option>
                        <option value="8">üÖøÔ∏è Parking</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea id="poiDescription" rows="4" placeholder="Describe this point of interest..."></textarea>
            </div>

            <div class="grid-3">
                <div class="form-group">
                    <label>Latitude *</label>
                    <input type="number" id="poiLatitude" step="0.000001" placeholder="33.5731" readonly>
                </div>
                <div class="form-group">
                    <label>Longitude *</label>
                    <input type="number" id="poiLongitude" step="0.000001" placeholder="-7.5898" readonly>
                </div>
                <div class="form-group">
                    <label>Country ID</label>
                    <input type="number" id="poiCountryId" placeholder="1 (Morocco)">
                </div>
            </div>

            <div class="form-group">
                <label>Address</label>
                <input type="text" id="poiAddress" placeholder="123 Main Street, Casablanca">
            </div>

            <div class="grid-3">
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" id="poiPhone" placeholder="+212 5XX XX XX XX">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="poiEmail" placeholder="contact@poi.com">
                </div>
                <div class="form-group">
                    <label>Website</label>
                    <input type="url" id="poiWebsite" placeholder="https://www.poi.com">
                </div>
            </div>

            <div class="form-group">
                <label>Opening Hours (JSON format)</label>
                <textarea id="poiOpeningHours" rows="3" placeholder='{"monday": "08:00-18:00", "tuesday": "08:00-18:00"}'></textarea>
            </div>

            <button class="btn" onclick="createPOI()">üöÄ Create POI</button>
            <div class="response-box" id="createResponse"></div>
        </div>

        <!-- List All POIs -->
        <div class="section" id="listSection" style="display: none;">
            <h2>üìã List All POIs</h2>
            <div class="grid-3">
                <div class="form-group">
                    <label>Filter by Type ID</label>
                    <input type="number" id="filterTypeId" placeholder="Leave empty for all">
                </div>
                <div class="form-group">
                    <label>Latitude (for nearby)</label>
                    <input type="number" id="filterLatitude" step="0.000001" placeholder="33.5731">
                </div>
                <div class="form-group">
                    <label>Longitude (for nearby)</label>
                    <input type="number" id="filterLongitude" step="0.000001" placeholder="-7.5898">
                </div>
            </div>
            <div class="form-group">
                <label>Radius (km)</label>
                <input type="number" id="filterRadius" placeholder="10" value="10">
            </div>
            <button class="btn" onclick="listPOIs()">üìã Get All POIs</button>
            <button class="btn btn-secondary" onclick="listNearbyPOIs()">üìç Get Nearby POIs</button>
            <div class="response-box" id="listResponse"></div>
            <div id="poisList" style="margin-top: 20px;"></div>
        </div>

        <!-- Get POI by ID + Display on Map -->
        <div class="section" id="showSection" style="display: none;">
            <h2>üîç Get POI Details & Display on Map</h2>
            <div class="form-group">
                <label>POI ID</label>
                <input type="number" id="showPoiId" placeholder="1">
            </div>
            <button class="btn" onclick="showPOI()">üîç Get POI Details</button>
            <button class="btn btn-secondary" onclick="displayPOIOnMap()">üó∫Ô∏è Display on Map</button>
            <div class="response-box" id="showResponse"></div>
            <div class="map-container">
                <div id="displayMap"></div>
            </div>
        </div>

        <!-- Update POI -->
        <div class="section" id="updateSection" style="display: none;">
            <h2>‚úèÔ∏è Update POI</h2>
            <div class="form-group">
                <label>POI ID *</label>
                <input type="number" id="updatePoiId" placeholder="1">
            </div>
            <button class="btn btn-secondary" onclick="loadPOIForUpdate()">üì• Load POI Data</button>

            <div id="updateForm" style="display: none; margin-top: 20px;">
                <div class="grid-2">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="updatePoiName">
                    </div>
                    <div class="form-group">
                        <label>Type ID</label>
                        <input type="number" id="updatePoiType">
                    </div>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="updatePoiDescription" rows="4"></textarea>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="text" id="updatePoiPhone">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="updatePoiEmail">
                    </div>
                </div>

                <button class="btn" onclick="updatePOI()">üíæ Update POI</button>
            </div>

            <div class="response-box" id="updateResponse"></div>
        </div>

        <!-- Delete POI -->
        <div class="section" id="deleteSection" style="display: none;">
            <h2>üóëÔ∏è Delete POI</h2>
            <div class="form-group">
                <label>POI ID</label>
                <input type="number" id="deletePoiId" placeholder="1">
            </div>
            <button class="btn btn-danger" onclick="deletePOI()">üóëÔ∏è Delete POI</button>
            <div class="response-box" id="deleteResponse"></div>
        </div>

        <!-- Toggle Favorite -->
        <div class="section" id="favoriteSection" style="display: none;">
            <h2>‚≠ê Toggle Favorite</h2>
            <div class="form-group">
                <label>POI ID</label>
                <input type="number" id="favoritePoiId" placeholder="1">
            </div>
            <button class="btn" onclick="toggleFavorite()">‚≠ê Toggle Favorite</button>
            <div class="response-box" id="favoriteResponse"></div>
        </div>

        <!-- Get Favorites -->
        <div class="section" id="favoritesListSection" style="display: none;">
            <h2>‚≠ê My Favorite POIs</h2>
            <div class="form-group">
                <label>Filter by Type ID (optional)</label>
                <input type="number" id="favoritesTypeId" placeholder="Leave empty for all">
            </div>
            <button class="btn" onclick="getFavorites()">‚≠ê Get My Favorites</button>
            <div class="response-box" id="favoritesListResponse"></div>
            <div id="favoritesList" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîê Login to DabApp</h3>
                <button class="close-modal" onclick="closeLoginModal()">‚úï</button>
            </div>

            <div class="form-group">
                <label>Email or Phone *</label>
                <input type="text" id="loginInput" placeholder="john.doe@example.com or +212688808238">
            </div>

            <div class="form-group">
                <label>Password *</label>
                <input type="password" id="passwordInput" placeholder="Your password">
            </div>

            <button class="btn btn-success" style="width: 100%;" onclick="performLogin()">
                üöÄ Login
            </button>

            <div class="response-box" id="loginResponse" style="display: none;"></div>
        </div>
    </div>

<script>
    // ===== GLOBAL VARIABLES =====
    let currentUser = null;
    let authToken = null;
    let map;
    let displayMap;
    let marker = null;
    let displayMarker = null;
    let placesService;
    let currentPlaceData = null;
    let placeMarkers = []; // Array to store markers for nearby places
    let activeInfoWindow = null; // Track currently open info window

    const GOOGLE_MAPS_API_KEY = 'AIzaSyBznLyPEvm9nm3LerujutDMx1F6zNSpk2E';

    const mapStyles = [
        {"featureType": "all", "elementType": "geometry", "stylers": [{"color": "#242f3e"}]},
        {"featureType": "road", "elementType": "geometry.fill", "stylers": [{"color": "#2b2b2b"}]},
        {"featureType": "road", "elementType": "labels.text.fill", "stylers": [{"color": "#ff6b00"}]},
        {"featureType": "road.highway", "elementType": "geometry.stroke", "stylers": [{"color": "#ff6b00"}]},
        {"featureType": "water", "elementType": "geometry", "stylers": [{"color": "#17263c"}]}
    ];

    // ===== AUTHENTICATION =====
    function checkAuth() {
        const storedToken = localStorage.getItem('dabapp_token');
        const storedUser = localStorage.getItem('dabapp_user');

        if (storedToken && storedUser) {
            authToken = storedToken;
            currentUser = JSON.parse(storedUser);
            document.getElementById('authToken').value = authToken;
            updateAuthUI();
        } else {
            updateAuthStatus(false);
        }
    }

    function showLoginModal() {
        document.getElementById('loginModal').style.display = 'block';
    }

    function closeLoginModal() {
        document.getElementById('loginModal').style.display = 'none';
        document.getElementById('loginResponse').style.display = 'none';
    }

    async function performLogin() {
        const login = document.getElementById('loginInput').value;
        const password = document.getElementById('passwordInput').value;
        const responseBox = document.getElementById('loginResponse');

        if (!login || !password) {
            responseBox.style.display = 'block';
            responseBox.innerHTML = '<pre class="error">‚ùå Please enter login and password!</pre>';
            return;
        }

        responseBox.style.display = 'block';
        responseBox.innerHTML = '<pre>üîÑ Authenticating...</pre>';

        try {
            const response = await fetch('https://be.dabapp.co/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ login: login, password: password })
            });

            const result = await response.json();

            if (result.user && result.token) {
                currentUser = result.user;
                authToken = result.token;
                localStorage.setItem('dabapp_token', authToken);
                localStorage.setItem('dabapp_user', JSON.stringify(currentUser));
                document.getElementById('authToken').value = authToken;
                responseBox.innerHTML = '<pre class="success">‚úÖ Login successful!</pre>';
                setTimeout(() => {
                    closeLoginModal();
                    updateAuthUI();
                }, 2000);
            } else {
                responseBox.innerHTML = '<pre class="error">‚ùå Login failed!<br><br>' + JSON.stringify(result, null, 2) + '</pre>';
            }
        } catch (error) {
            responseBox.innerHTML = '<pre class="error">‚ùå Error: ' + error.message + '</pre>';
        }
    }

    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('dabapp_token');
            localStorage.removeItem('dabapp_user');
            currentUser = null;
            authToken = null;
            document.getElementById('authToken').value = '';
            updateAuthUI();
            location.reload();
        }
    }

    function updateAuthUI() {
        if (currentUser && authToken) {
            updateAuthStatus(true);
            showUserInfo();
            enableAllSections();
            document.getElementById('logoutBtn').style.display = 'inline-block';
        } else {
            updateAuthStatus(false);
            hideUserInfo();
            disableAllSections();
            document.getElementById('logoutBtn').style.display = 'none';
        }
    }

    function updateAuthStatus(isLoggedIn) {
        const statusDiv = document.getElementById('authStatus');
        if (isLoggedIn) {
            statusDiv.innerHTML = `<span class="auth-status logged-in">‚úÖ Authenticated as ${currentUser.first_name} ${currentUser.last_name}</span>`;
        } else {
            statusDiv.innerHTML = `<span class="auth-status logged-out">‚ö†Ô∏è Not Authenticated - Please Login</span>`;
        }
    }

    function showUserInfo() {
        const container = document.getElementById('userInfoContainer');
        container.innerHTML = `
            <div class="user-info-box">
                <h4>üë§ User Information</h4>
                <div class="user-info-item"><strong>Name:</strong> ${currentUser.first_name} ${currentUser.last_name}</div>
                <div class="user-info-item"><strong>Email:</strong> ${currentUser.email}</div>
                <div class="user-info-item"><strong>Role ID:</strong> ${currentUser.role_id}</div>
            </div>
        `;
    }

    function hideUserInfo() {
        document.getElementById('userInfoContainer').innerHTML = '';
    }

    function enableAllSections() {
        const sections = ['mapSection', 'createSection', 'listSection', 'showSection', 'updateSection', 'deleteSection', 'favoriteSection', 'favoritesListSection'];
        sections.forEach(id => document.getElementById(id).style.display = 'block');
    }

    function disableAllSections() {
        const sections = ['mapSection', 'createSection', 'listSection', 'showSection', 'updateSection', 'deleteSection', 'favoriteSection', 'favoritesListSection'];
        sections.forEach(id => document.getElementById(id).style.display = 'none');
    }

    // ===== GOOGLE MAPS & PLACES =====
    function initMap() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        if (!window.google) {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places,geometry`;
            script.onload = () => {
                setupMaps();
                getUserLocation();
            };
            document.head.appendChild(script);
        } else {
            setupMaps();
            getUserLocation();
        }
    }

    function setupMaps() {
        const center = { lat: 33.5731, lng: -7.5898 };

        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,
            center: center,
            styles: mapStyles,
            mapTypeControl: false,
            streetViewControl: false
        });

        displayMap = new google.maps.Map(document.getElementById('displayMap'), {
            zoom: 12,
            center: center,
            styles: mapStyles,
            mapTypeControl: false,
            streetViewControl: false
        });

        placesService = new google.maps.places.PlacesService(map);

        // Show nearby places on the map with hover tooltips
        map.addListener('idle', function() {
            showNearbyPlacesOnMap();
        });

        map.addListener('click', function(event) {
            selectLocation(event.latLng);
        });
    }

    function getUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const userPos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map.setCenter(userPos);
                    displayMap.setCenter(userPos);
                },
                function(error) {
                    console.warn('Geolocation disabled:', error);
                }
            );
        }
    }

    function selectLocation(location) {
        const position = {
            lat: location.lat(),
            lng: location.lng()
        };

        if (marker) {
            marker.setMap(null);
        }

        marker = new google.maps.Marker({
            position: position,
            map: map,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 12,
                fillColor: '#ff6b00',
                fillOpacity: 1,
                strokeColor: '#fff',
                strokeWeight: 2
            }
        });

        document.getElementById('poiLatitude').value = position.lat.toFixed(6);
        document.getElementById('poiLongitude').value = position.lng.toFixed(6);

        document.getElementById('selectedLocation').style.display = 'block';
        document.getElementById('selectedLat').textContent = position.lat.toFixed(6);
        document.getElementById('selectedLng').textContent = position.lng.toFixed(6);

        // Search for nearby places using Google Places API
        searchNearbyPlace(position);

        // Also display nearby places markers for hover
        searchAndDisplayNearbyPlaces(position);
    }

    function searchNearbyPlace(position) {
        const request = {
            location: position,
            radius: 100, // Search within 100 meters
            rankBy: google.maps.places.RankBy.DISTANCE
        };

        placesService.nearbySearch(request, function(results, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                // Get details of the nearest place
                getPlaceDetails(results[0].place_id);
            } else {
                // No place found, just geocode
                geocodeLocation(position);
            }
        });
    }

    // Search and display nearby places with markers
    let nearbyPlacesMarkers = [];

    function searchAndDisplayNearbyPlaces(center) {
        // Clear existing nearby markers
        nearbyPlacesMarkers.forEach(m => m.marker.setMap(null));
        nearbyPlacesMarkers = [];

        const request = {
            location: center,
            radius: 500, // Search within 500 meters
            type: ['restaurant', 'gas_station', 'cafe', 'hotel', 'tourist_attraction', 'store', 'parking']
        };

        placesService.nearbySearch(request, function(results, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                results.forEach((place, index) => {
                    if (index < 30) { // Limit to 30 places to avoid clutter
                        createPlaceMarker(place);
                    }
                });
            }
        });
    }

    function createPlaceMarker(place) {
        const placeMarker = new google.maps.Marker({
            position: place.geometry.location,
            map: map,
            icon: {
                url: place.icon,
                scaledSize: new google.maps.Size(25, 25)
            },
            title: place.name,
            animation: google.maps.Animation.DROP
        });

        const previewInfoWindow = new google.maps.InfoWindow();

        // Hover effect - show preview
        placeMarker.addListener('mouseover', function() {
            const previewContent = `
                <div style="color: #000; padding: 10px; max-width: 250px;">
                    <h4 style="margin: 0 0 8px 0; color: #ff6b00;">${place.name}</h4>
                    <p style="margin: 5px 0; font-size: 12px; color: #666;">${place.vicinity}</p>
                    ${place.rating ? `
                        <div style="margin: 5px 0;">
                            <span style="color: #ffc107;">‚òÖ</span>
                            <strong>${place.rating}</strong>
                            <span style="color: #999; font-size: 11px;">(${place.user_ratings_total || 0} avis)</span>
                        </div>
                    ` : ''}
                    ${place.opening_hours ? `
                        <p style="margin: 5px 0; font-size: 12px;">
                            ${place.opening_hours.open_now ?
                                '<span style="color: #4caf50;">‚úì Ouvert maintenant</span>' :
                                '<span style="color: #d32f2f;">‚úó Ferm√©</span>'}
                        </p>
                    ` : ''}
                    <p style="margin: 8px 0 0 0; font-size: 11px; color: #ff6b00;">
                        <strong>Cliquez pour r√©cup√©rer toutes les infos</strong>
                    </p>
                </div>
            `;
            previewInfoWindow.setContent(previewContent);
            previewInfoWindow.open(map, placeMarker);
        });

        // Mouse out - close preview
        placeMarker.addListener('mouseout', function() {
            previewInfoWindow.close();
        });

        // Click - get full details and fill form
        placeMarker.addListener('click', function() {
            previewInfoWindow.close();

            // Set the main marker position
            if (marker) {
                marker.setMap(null);
            }

            marker = new google.maps.Marker({
                position: place.geometry.location,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 15,
                    fillColor: '#ff6b00',
                    fillOpacity: 1,
                    strokeColor: '#fff',
                    strokeWeight: 3
                },
                animation: google.maps.Animation.BOUNCE
            });

            setTimeout(() => {
                marker.setAnimation(null);
            }, 2000);

            const lat = place.geometry.location.lat();
            const lng = place.geometry.location.lng();

            document.getElementById('poiLatitude').value = lat.toFixed(6);
            document.getElementById('poiLongitude').value = lng.toFixed(6);

            document.getElementById('selectedLocation').style.display = 'block';
            document.getElementById('selectedLat').textContent = lat.toFixed(6);
            document.getElementById('selectedLng').textContent = lng.toFixed(6);

            // Get full place details
            getPlaceDetails(place.place_id, true);

            // Center map on selected place
            map.panTo(place.geometry.location);
            map.setZoom(16);
        });

        nearbyPlacesMarkers.push({ marker: placeMarker, place: place });
    }

    function getPlaceDetails(placeId, autoFillForm = false) {
        const request = {
            placeId: placeId,
            fields: [
                'name', 'formatted_address', 'geometry', 'rating', 'user_ratings_total',
                'reviews', 'formatted_phone_number', 'international_phone_number',
                'website', 'opening_hours', 'photos', 'types', 'price_level',
                'business_status', 'url'
            ]
        };

        placesService.getDetails(request, function(place, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                currentPlaceData = place;
                displayPlaceInfo(place);

                // Auto-fill form if requested (when clicking on a marker)
                if (autoFillForm) {
                    usePlaceData();

                    // Scroll to form section
                    setTimeout(() => {
                        window.scrollTo({
                            top: document.getElementById('createSection').offsetTop - 20,
                            behavior: 'smooth'
                        });
                    }, 500);
                }
            }
        });
    }

    function geocodeLocation(position) {
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ location: position }, function(results, status) {
            if (status === 'OK' && results[0]) {
                document.getElementById('poiAddress').value = results[0].formatted_address;
            }
        });
    }

    function displayPlaceInfo(place) {
        const infoBox = document.getElementById('placeInfoBox');
        infoBox.style.display = 'block';

        let starsHtml = '';
        if (place.rating) {
            const fullStars = Math.floor(place.rating);
            const hasHalfStar = place.rating % 1 >= 0.5;

            for (let i = 0; i < fullStars; i++) {
                starsHtml += '‚≠ê';
            }
            if (hasHalfStar) {
                starsHtml += '‚ú®';
            }
        }

        let openingHoursHtml = '';
        if (place.opening_hours && place.opening_hours.weekday_text) {
            openingHoursHtml = `
                <div class="place-detail">
                    <strong>üïê Horaires d'ouverture:</strong><br>
                    ${place.opening_hours.weekday_text.map(day => `<div style="margin: 3px 0; padding-left: 10px;">${day}</div>`).join('')}
                </div>
            `;
        }

        let photosHtml = '';
        if (place.photos && place.photos.length > 0) {
            photosHtml = `
                <div class="place-detail">
                    <strong>üì∑ Photos:</strong><br>
                    <div style="display: flex; gap: 10px; margin-top: 10px; overflow-x: auto;">
                        ${place.photos.slice(0, 3).map(photo =>
                            `<img src="${photo.getUrl({maxWidth: 200})}" style="max-width: 200px; border-radius: 5px;">`
                        ).join('')}
                    </div>
                </div>
            `;
        }

        let reviewsHtml = '';
        if (place.reviews && place.reviews.length > 0) {
            reviewsHtml = `
                <div class="place-detail">
                    <strong>üí¨ Avis r√©cents:</strong><br>
                    ${place.reviews.slice(0, 3).map(review => `
                        <div class="review-item">
                            <div class="review-author">${review.author_name} - ${'‚≠ê'.repeat(review.rating)}</div>
                            <div class="review-text">${review.text}</div>
                            <div style="color: #999; font-size: 11px; margin-top: 5px;">${review.relative_time_description}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        infoBox.innerHTML = `
            <div class="place-info-box">
                <h4>
                    <span>üéØ Lieu Google Maps trouv√©!</span>
                </h4>

                <div class="place-detail">
                    <strong>üìç Nom:</strong> ${place.name}
                </div>

                <div class="place-detail">
                    <strong>üìÆ Adresse:</strong> ${place.formatted_address || 'N/A'}
                </div>

                ${place.rating ? `
                    <div class="place-detail">
                        <strong>‚≠ê Note:</strong> ${place.rating} / 5
                        <div class="rating-stars">${starsHtml} (${place.user_ratings_total} avis)</div>
                    </div>
                ` : ''}

                ${place.formatted_phone_number ? `
                    <div class="place-detail">
                        <strong>üìû T√©l√©phone:</strong> ${place.formatted_phone_number}
                    </div>
                ` : ''}

                ${place.website ? `
                    <div class="place-detail">
                        <strong>üåê Site web:</strong> <a href="${place.website}" target="_blank" style="color: #4caf50;">${place.website}</a>
                    </div>
                ` : ''}

                ${place.types ? `
                    <div class="place-detail">
                        <strong>üè∑Ô∏è Types:</strong> ${place.types.slice(0, 5).join(', ')}
                    </div>
                ` : ''}

                ${place.business_status ? `
                    <div class="place-detail">
                        <strong>üè™ Statut:</strong> ${place.business_status === 'OPERATIONAL' ? '‚úÖ Op√©rationnel' : place.business_status}
                    </div>
                ` : ''}

                ${openingHoursHtml}

                ${photosHtml}

                ${reviewsHtml}

                ${place.url ? `
                    <div class="place-detail">
                        <strong>üîó Google Maps:</strong> <a href="${place.url}" target="_blank" style="color: #4caf50;">Voir sur Google Maps</a>
                    </div>
                ` : ''}

                <button class="use-place-data-btn" onclick="usePlaceData()">
                    ‚úÖ Utiliser ces donn√©es pour cr√©er le POI
                </button>
            </div>
        `;

        // Auto-fill address
        document.getElementById('poiAddress').value = place.formatted_address || '';
    }

    function usePlaceData() {
        if (!currentPlaceData) return;

        const place = currentPlaceData;

        // Fill ALL form fields with Google data
        document.getElementById('poiName').value = place.name || '';
        document.getElementById('poiAddress').value = place.formatted_address || '';

        // Phone number
        if (place.formatted_phone_number) {
            document.getElementById('poiPhone').value = place.formatted_phone_number;
        } else if (place.international_phone_number) {
            document.getElementById('poiPhone').value = place.international_phone_number;
        }

        // Website
        document.getElementById('poiWebsite').value = place.website || '';

        // Create comprehensive description from Google data
        let description = '';

        // Add rating and reviews count
        if (place.rating) {
            description += `‚≠ê Note Google: ${place.rating}/5 (${place.user_ratings_total || 0} avis)\n\n`;
        }

        // Add business status
        if (place.business_status) {
            description += `üìä Statut: ${place.business_status === 'OPERATIONAL' ? 'Op√©rationnel' : place.business_status}\n\n`;
        }

        // Add types
        if (place.types && place.types.length > 0) {
            description += `üè∑Ô∏è Types: ${place.types.slice(0, 5).join(', ')}\n\n`;
        }

        // Add price level
        if (place.price_level) {
            description += `üí∞ Niveau de prix: ${'üíµ'.repeat(place.price_level)}\n\n`;
        }

        // Add opening hours status
        if (place.opening_hours) {
            if (place.opening_hours.isOpen !== undefined) {
                description += `üïê Actuellement: ${place.opening_hours.isOpen() ? 'Ouvert ‚úÖ' : 'Ferm√© ‚ùå'}\n\n`;
            }
        }

        // Add a sample review if available
        if (place.reviews && place.reviews.length > 0) {
            const topReview = place.reviews[0];
            description += `üí¨ Avis r√©cent (${topReview.rating}‚≠ê):\n"${topReview.text.substring(0, 150)}${topReview.text.length > 150 ? '...' : ''}"\n- ${topReview.author_name}\n\n`;
        }

        // Add Google Maps URL
        if (place.url) {
            description += `üîó Voir sur Google Maps: ${place.url}`;
        }

        document.getElementById('poiDescription').value = description;

        // Opening hours as JSON (properly formatted)
        if (place.opening_hours && place.opening_hours.weekday_text) {
            const openingHoursObj = {};
            const daysMap = {
                'Monday': 'monday',
                'Tuesday': 'tuesday',
                'Wednesday': 'wednesday',
                'Thursday': 'thursday',
                'Friday': 'friday',
                'Saturday': 'saturday',
                'Sunday': 'sunday',
                'Lundi': 'monday',
                'Mardi': 'tuesday',
                'Mercredi': 'wednesday',
                'Jeudi': 'thursday',
                'Vendredi': 'friday',
                'Samedi': 'saturday',
                'Dimanche': 'sunday'
            };

            place.opening_hours.weekday_text.forEach((text, index) => {
                // Split on colon or French colon
                const parts = text.split(/:\s*/);
                if (parts.length >= 2) {
                    const dayName = parts[0].trim();
                    const hours = parts.slice(1).join(':').trim();

                    // Try to find matching day
                    const matchedDay = Object.keys(daysMap).find(key =>
                        dayName.toLowerCase().includes(key.toLowerCase())
                    );

                    if (matchedDay) {
                        openingHoursObj[daysMap[matchedDay]] = hours;
                    }
                } else {
                    // Fallback to index-based mapping
                    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                    openingHoursObj[days[index]] = text;
                }
            });

            document.getElementById('poiOpeningHours').value = JSON.stringify(openingHoursObj, null, 2);
        }

        // Auto-select POI type based on Google types (with more mapping)
        if (place.types) {
            const typeMapping = {
                'gas_station': '1',
                'car_repair': '2',
                'car_dealer': '2',
                'store': '3',
                'shopping_mall': '3',
                'lodging': '4',
                'hotel': '4',
                'restaurant': '5',
                'cafe': '5',
                'bar': '5',
                'food': '5',
                'tourist_attraction': '7',
                'museum': '7',
                'park': '6',
                'natural_feature': '6',
                'parking': '8'
            };

            // Find first matching type
            for (const googleType of place.types) {
                if (typeMapping[googleType]) {
                    document.getElementById('poiType').value = typeMapping[googleType];
                    break;
                }
            }
        }

        // Try to extract country from address components
        if (place.address_components) {
            const countryComponent = place.address_components.find(
                comp => comp.types.includes('country')
            );

            if (countryComponent) {
                // Morocco = 1, France = 2, etc. (adjust based on your database)
                const countryMap = {
                    'MA': '1', // Morocco
                    'FR': '2', // France
                    'ES': '3', // Spain
                    'US': '4', // USA
                };

                const countryCode = countryComponent.short_name;
                if (countryMap[countryCode]) {
                    document.getElementById('poiCountryId').value = countryMap[countryCode];
                }
            }
        }

        // Scroll to form
        window.scrollTo({
            top: document.getElementById('createSection').offsetTop - 20,
            behavior: 'smooth'
        });

        // Show success message
        const successMsg = document.createElement('div');
        successMsg.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            font-weight: bold;
            animation: slideInRight 0.5s ease-out;
        `;
        successMsg.innerHTML = `
            ‚úÖ Donn√©es Google Places charg√©es!<br>
            <small style="font-weight: normal;">Nom, adresse, t√©l√©phone, site web, horaires...</small>
        `;
        document.body.appendChild(successMsg);

        setTimeout(() => {
            successMsg.style.animation = 'slideOutRight 0.5s ease-in';
            setTimeout(() => successMsg.remove(), 500);
        }, 3000);
    }

    function clearMarker() {
        if (marker) {
            marker.setMap(null);
            marker = null;
        }

        // Clear nearby places markers
        if (nearbyPlacesMarkers && nearbyPlacesMarkers.length > 0) {
            nearbyPlacesMarkers.forEach(m => m.marker.setMap(null));
            nearbyPlacesMarkers = [];
        }

        document.getElementById('poiLatitude').value = '';
        document.getElementById('poiLongitude').value = '';
        document.getElementById('poiAddress').value = '';
        document.getElementById('selectedLocation').style.display = 'none';
        document.getElementById('placeInfoBox').style.display = 'none';
        currentPlaceData = null;
    }

    function showNearbyPlacesAroundCenter() {
        if (!map) {
            alert('‚ö†Ô∏è Please load the map first!');
            return;
        }

        const center = map.getCenter();
        searchAndDisplayNearbyPlaces({
            lat: center.lat(),
            lng: center.lng()
        });

        alert('‚úÖ Nearby places loaded! Hover over markers to see info, click to select.');
    }

    // ===== SHOW NEARBY PLACES ON MAP =====
    function showNearbyPlacesOnMap() {
        // Clear existing place markers
        placeMarkers.forEach(marker => marker.setMap(null));
        placeMarkers = [];

        const center = map.getCenter();

        // Search for various types of places
        const placeTypes = [
            'gas_station', 'restaurant', 'cafe', 'lodging', 'tourist_attraction',
            'car_repair', 'parking', 'store', 'point_of_interest'
        ];

        const request = {
            location: center,
            radius: 2000, // 2km radius
            type: placeTypes
        };

        placesService.nearbySearch(request, function(results, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                // Limit to 20 places to avoid clutter
                const limitedResults = results.slice(0, 20);

                limitedResults.forEach(place => {
                    createPlaceMarker(place);
                });
            }
        });
    }

    function createPlaceMarker(place) {
        const placeMarker = new google.maps.Marker({
            position: place.geometry.location,
            map: map,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 8,
                fillColor: '#4caf50',
                fillOpacity: 0.8,
                strokeColor: '#fff',
                strokeWeight: 2
            },
            title: place.name,
            zIndex: 100
        });

        // Create hover tooltip
        const infoWindow = new google.maps.InfoWindow({
            content: createHoverContent(place)
        });

        // Show info on hover
        placeMarker.addListener('mouseover', function() {
            // Close any previously open info window
            if (activeInfoWindow) {
                activeInfoWindow.close();
            }
            infoWindow.open(map, placeMarker);
            activeInfoWindow = infoWindow;
        });

        // Close info on mouseout
        placeMarker.addListener('mouseout', function() {
            infoWindow.close();
        });

        // Click to get full details and auto-fill form
        placeMarker.addListener('click', function() {
            selectLocationFromPlace(place);
        });

        placeMarkers.push(placeMarker);
    }

    function createHoverContent(place) {
        const rating = place.rating ? `‚≠ê ${place.rating}` : 'No rating';
        const priceLevel = place.price_level ? 'üí∞'.repeat(place.price_level) : '';
        const openNow = place.opening_hours?.open_now ?
            '<span style="color: #4caf50;">üü¢ Open</span>' :
            '<span style="color: #f44336;">üî¥ Closed</span>';

        return `
            <div style="
                padding: 12px;
                min-width: 200px;
                max-width: 300px;
                font-family: Arial, sans-serif;
                background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%);
                border-radius: 8px;
                border: 2px solid #4caf50;
            ">
                <h3 style="
                    margin: 0 0 8px 0;
                    color: #4caf50;
                    font-size: 14px;
                    font-weight: bold;
                ">${place.name}</h3>

                <div style="color: #ccc; font-size: 12px; margin: 5px 0;">
                    üìç ${place.vicinity || 'No address'}
                </div>

                ${place.types && place.types.length > 0 ? `
                    <div style="color: #ff6b00; font-size: 11px; margin: 5px 0;">
                        üè∑Ô∏è ${place.types[0].replace(/_/g, ' ')}
                    </div>
                ` : ''}

                <div style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-top: 8px;
                    padding-top: 8px;
                    border-top: 1px solid #444;
                ">
                    <span style="color: #ffc107; font-size: 12px;">${rating}</span>
                    ${priceLevel ? `<span style="color: #ff9800; font-size: 12px;">${priceLevel}</span>` : ''}
                    ${place.opening_hours ? `<span style="font-size: 11px;">${openNow}</span>` : ''}
                </div>

                <div style="
                    margin-top: 10px;
                    padding: 6px;
                    background: rgba(76, 175, 80, 0.1);
                    border-radius: 4px;
                    text-align: center;
                    color: #4caf50;
                    font-size: 11px;
                    font-weight: bold;
                ">
                    üñ±Ô∏è Click to use this place
                </div>
            </div>
        `;
    }

    function selectLocationFromPlace(place) {
        const position = {
            lat: place.geometry.location.lat(),
            lng: place.geometry.location.lng()
        };

        // Remove existing marker
        if (marker) {
            marker.setMap(null);
        }

        // Create selection marker
        marker = new google.maps.Marker({
            position: position,
            map: map,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 15,
                fillColor: '#ff6b00',
                fillOpacity: 1,
                strokeColor: '#fff',
                strokeWeight: 3
            },
            animation: google.maps.Animation.BOUNCE,
            zIndex: 1000
        });

        // Stop bounce after 2 seconds
        setTimeout(() => {
            marker.setAnimation(null);
        }, 2000);

        // Center map on selected place
        map.panTo(position);
        map.setZoom(16);

        // Fill coordinates
        document.getElementById('poiLatitude').value = position.lat.toFixed(6);
        document.getElementById('poiLongitude').value = position.lng.toFixed(6);

        document.getElementById('selectedLocation').style.display = 'block';
        document.getElementById('selectedLat').textContent = position.lat.toFixed(6);
        document.getElementById('selectedLng').textContent = position.lng.toFixed(6);

        // Get full place details
        getPlaceDetails(place.place_id);
    }

    // ===== API FUNCTIONS =====
    function getHeaders() {
        return {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'Authorization': authToken ? `Bearer ${authToken}` : ''
        };
    }

    function getApiUrl() {
        return document.getElementById('apiUrl').value;
    }

    async function createPOI() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const responseBox = document.getElementById('createResponse');

        const name = document.getElementById('poiName').value;
        const type_id = document.getElementById('poiType').value;
        const latitude = document.getElementById('poiLatitude').value;
        const longitude = document.getElementById('poiLongitude').value;

        if (!name || !type_id || !latitude || !longitude) {
            responseBox.innerHTML = '<pre class="error">‚ùå Please fill all required fields (Name, Type, Location)</pre>';
            return;
        }

        const data = {
            name: name,
            description: document.getElementById('poiDescription').value,
            type_id: parseInt(type_id),
            latitude: parseFloat(latitude),
            longitude: parseFloat(longitude),
            address: document.getElementById('poiAddress').value,
            country_id: document.getElementById('poiCountryId').value ? parseInt(document.getElementById('poiCountryId').value) : null,
            phone: document.getElementById('poiPhone').value,
            email: document.getElementById('poiEmail').value,
            website: document.getElementById('poiWebsite').value,
        };

        const openingHours = document.getElementById('poiOpeningHours').value;
        if (openingHours) {
            try {
                data.opening_hours = JSON.parse(openingHours);
            } catch (e) {
                responseBox.innerHTML = '<pre class="error">‚ùå Invalid JSON format for opening hours</pre>';
                return;
            }
        }

        responseBox.innerHTML = '<pre>üîÑ Creating POI...</pre>';

        try {
            const response = await fetch(`${getApiUrl()}/pois`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify(data)
            });

            const result = await response.json();
            responseBox.innerHTML = `<pre class="${result.success ? 'success' : 'error'}">${JSON.stringify(result, null, 2)}</pre>`;

            if (result.success && result.data) {
                document.getElementById('showPoiId').value = result.data.id;
                document.getElementById('updatePoiId').value = result.data.id;
                document.getElementById('deletePoiId').value = result.data.id;
                document.getElementById('favoritePoiId').value = result.data.id;
            }
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    async function listPOIs() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const responseBox = document.getElementById('listResponse');
        responseBox.innerHTML = '<pre>üîÑ Loading POIs...</pre>';

        let url = `${getApiUrl()}/pois`;
        const params = new URLSearchParams();

        const typeId = document.getElementById('filterTypeId').value;
        if (typeId) params.append('type_id', typeId);

        if (params.toString()) url += '?' + params.toString();

        try {
            const response = await fetch(url, { headers: getHeaders() });
            const result = await response.json();
            responseBox.innerHTML = `<pre class="success">${JSON.stringify(result, null, 2)}</pre>`;

            if (result.success && result.data && result.data.data) {
                displayPOIsList(result.data.data);
            }
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    async function listNearbyPOIs() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const responseBox = document.getElementById('listResponse');
        const latitude = document.getElementById('filterLatitude').value;
        const longitude = document.getElementById('filterLongitude').value;
        const radius = document.getElementById('filterRadius').value;

        if (!latitude || !longitude) {
            responseBox.innerHTML = '<pre class="error">‚ùå Please enter latitude and longitude</pre>';
            return;
        }

        responseBox.innerHTML = '<pre>üîÑ Loading nearby POIs...</pre>';

        const params = new URLSearchParams({
            latitude: latitude,
            longitude: longitude,
            radius: radius || 10
        });

        const typeId = document.getElementById('filterTypeId').value;
        if (typeId) params.append('type_id', typeId);

        try {
            const response = await fetch(`${getApiUrl()}/pois?${params.toString()}`, {
                headers: getHeaders()
            });
            const result = await response.json();
            responseBox.innerHTML = `<pre class="success">${JSON.stringify(result, null, 2)}</pre>`;

            if (result.success && result.data && result.data.data) {
                displayPOIsList(result.data.data);
            }
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    function displayPOIsList(pois) {
        const listDiv = document.getElementById('poisList');

        if (!pois || pois.length === 0) {
            listDiv.innerHTML = '<p style="color: #999;">No POIs found</p>';
            return;
        }

        let html = '<h3 style="color: #ff6b00; margin-bottom: 15px;">Found ' + pois.length + ' POI(s)</h3>';

        pois.forEach(poi => {
            const typeName = poi.type ? poi.type.name : 'Unknown';
            const verified = poi.is_verified ? '‚úÖ Verified' : '‚ö†Ô∏è Not Verified';

            html += `
                <div class="poi-card" onclick="showPOIById(${poi.id})">
                    <h4>${poi.name}</h4>
                    <div style="margin-bottom: 10px;">
                        <span class="poi-type-badge">${typeName}</span>
                        <span style="color: ${poi.is_verified ? '#4caf50' : '#ff9800'}; font-size: 12px;">${verified}</span>
                    </div>
                    <p class="description">${poi.description || 'No description'}</p>
                    <p class="location">üìç ${poi.address || 'No address'}</p>
                    <p class="location">üåç Lat: ${poi.latitude}, Lng: ${poi.longitude}</p>
                    ${poi.phone ? `<p style="color: #ccc; font-size: 13px;">üìû ${poi.phone}</p>` : ''}
                    ${poi.views_count ? `<p style="color: #999; font-size: 12px; margin-top: 5px;">üëÅÔ∏è ${poi.views_count} views</p>` : ''}
                </div>
            `;
        });

        listDiv.innerHTML = html;
    }

    function showPOIById(id) {
        document.getElementById('showPoiId').value = id;
        showPOI();
        window.scrollTo({ top: document.getElementById('showSection').offsetTop - 20, behavior: 'smooth' });
    }

    async function showPOI() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const poiId = document.getElementById('showPoiId').value;
        const responseBox = document.getElementById('showResponse');

        if (!poiId) {
            responseBox.innerHTML = '<pre class="error">‚ùå Please enter a POI ID</pre>';
            return;
        }

        responseBox.innerHTML = '<pre>üîÑ Loading POI...</pre>';

        try {
            const response = await fetch(`${getApiUrl()}/pois/${poiId}`, {
                headers: getHeaders()
            });
            const result = await response.json();
            responseBox.innerHTML = `<pre class="${result.success ? 'success' : 'error'}">${JSON.stringify(result, null, 2)}</pre>`;
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    async function displayPOIOnMap() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const poiId = document.getElementById('showPoiId').value;

        if (!poiId) {
            alert('‚ùå Please enter a POI ID');
            return;
        }

        try {
            const response = await fetch(`${getApiUrl()}/pois/${poiId}`, {
                headers: getHeaders()
            });
            const result = await response.json();

            if (result.success && result.data) {
                const poi = result.data;
                const position = {
                    lat: parseFloat(poi.latitude),
                    lng: parseFloat(poi.longitude)
                };

                if (displayMarker) displayMarker.setMap(null);

                displayMarker = new google.maps.Marker({
                    position: position,
                    map: displayMap,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 15,
                        fillColor: '#ff6b00',
                        fillOpacity: 1,
                        strokeColor: '#fff',
                        strokeWeight: 3
                    }
                });

                const infoContent = `
                    <div style="color: #000; padding: 10px; max-width: 300px;">
                        <h3 style="margin: 0 0 10px 0;">${poi.name}</h3>
                        <p><strong>Type:</strong> ${poi.type ? poi.type.name : 'N/A'}</p>
                        <p><strong>Address:</strong> ${poi.address || 'N/A'}</p>
                        ${poi.phone ? `<p><strong>Phone:</strong> ${poi.phone}</p>` : ''}
                        ${poi.description ? `<p style="margin-top: 10px;">${poi.description}</p>` : ''}
                    </div>
                `;

                const infowindow = new google.maps.InfoWindow({ content: infoContent });
                infowindow.open(displayMap, displayMarker);

                displayMap.setCenter(position);
                displayMap.setZoom(15);
            }
        } catch (error) {
            alert('‚ùå Error: ' + error.message);
        }
    }

    async function loadPOIForUpdate() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const poiId = document.getElementById('updatePoiId').value;
        const responseBox = document.getElementById('updateResponse');

        if (!poiId) {
            responseBox.innerHTML = '<pre class="error">‚ùå Please enter a POI ID</pre>';
            return;
        }

        responseBox.innerHTML = '<pre>üîÑ Loading POI data...</pre>';

        try {
            const response = await fetch(`${getApiUrl()}/pois/${poiId}`, {
                headers: getHeaders()
            });
            const result = await response.json();

            if (result.success && result.data) {
                const poi = result.data;
                document.getElementById('updatePoiName').value = poi.name;
                document.getElementById('updatePoiType').value = poi.type_id;
                document.getElementById('updatePoiDescription').value = poi.description || '';
                document.getElementById('updatePoiPhone').value = poi.phone || '';
                document.getElementById('updatePoiEmail').value = poi.email || '';

                document.getElementById('updateForm').style.display = 'block';
                responseBox.innerHTML = '<pre class="success">‚úÖ POI data loaded successfully</pre>';
            } else {
                responseBox.innerHTML = `<pre class="error">${JSON.stringify(result, null, 2)}</pre>`;
            }
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    async function updatePOI() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const poiId = document.getElementById('updatePoiId').value;
        const responseBox = document.getElementById('updateResponse');

        if (!poiId) {
            responseBox.innerHTML = '<pre class="error">‚ùå Please enter a POI ID</pre>';
            return;
        }

        const data = {
            name: document.getElementById('updatePoiName').value,
            type_id: parseInt(document.getElementById('updatePoiType').value),
            description: document.getElementById('updatePoiDescription').value,
            phone: document.getElementById('updatePoiPhone').value,
            email: document.getElementById('updatePoiEmail').value,
        };

        responseBox.innerHTML = '<pre>üîÑ Updating POI...</pre>';

        try {
            const response = await fetch(`${getApiUrl()}/pois/${poiId}`, {
                method: 'PUT',
                headers: getHeaders(),
                body: JSON.stringify(data)
            });
            const result = await response.json();
            responseBox.innerHTML = `<pre class="${result.success ? 'success' : 'error'}">${JSON.stringify(result, null, 2)}</pre>`;
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    async function deletePOI() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const poiId = document.getElementById('deletePoiId').value;
        const responseBox = document.getElementById('deleteResponse');

        if (!poiId) {
            responseBox.innerHTML = '<pre class="error">‚ùå Please enter a POI ID</pre>';
            return;
        }

        if (!confirm('‚ö†Ô∏è Are you sure you want to delete this POI?')) {
            return;
        }

        responseBox.innerHTML = '<pre>üîÑ Deleting POI...</pre>';

        try {
            const response = await fetch(`${getApiUrl()}/pois/${poiId}`, {
                method: 'DELETE',
                headers: getHeaders()
            });
            const result = await response.json();
            responseBox.innerHTML = `<pre class="${result.success ? 'success' : 'error'}">${JSON.stringify(result, null, 2)}</pre>`;
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    async function toggleFavorite() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const poiId = document.getElementById('favoritePoiId').value;
        const responseBox = document.getElementById('favoriteResponse');

        if (!poiId) {
            responseBox.innerHTML = '<pre class="error">‚ùå Please enter a POI ID</pre>';
            return;
        }

        responseBox.innerHTML = '<pre>üîÑ Toggling favorite...</pre>';

        try {
            const response = await fetch(`${getApiUrl()}/pois/${poiId}/favorite`, {
                method: 'POST',
                headers: getHeaders()
            });
            const result = await response.json();
            responseBox.innerHTML = `<pre class="${result.success ? 'success' : 'error'}">${JSON.stringify(result, null, 2)}</pre>`;
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    async function getFavorites() {
        if (!authToken) {
            alert('‚ö†Ô∏è Please login first!');
            return;
        }

        const responseBox = document.getElementById('favoritesListResponse');
        responseBox.innerHTML = '<pre>üîÑ Loading favorites...</pre>';

        let url = `${getApiUrl()}/pois/favorites`;
        const params = new URLSearchParams();

        const typeId = document.getElementById('favoritesTypeId').value;
        if (typeId) params.append('type_id', typeId);

        if (params.toString()) url += '?' + params.toString();

        try {
            const response = await fetch(url, { headers: getHeaders() });
            const result = await response.json();
            responseBox.innerHTML = `<pre class="success">${JSON.stringify(result, null, 2)}</pre>`;

            if (result.success && result.data && result.data.data) {
                displayFavoritesList(result.data.data);
            }
        } catch (error) {
            responseBox.innerHTML = `<pre class="error">‚ùå Error: ${error.message}</pre>`;
        }
    }

    function displayFavoritesList(pois) {
        const listDiv = document.getElementById('favoritesList');

        if (!pois || pois.length === 0) {
            listDiv.innerHTML = '<p style="color: #999;">No favorite POIs found</p>';
            return;
        }

        let html = '<h3 style="color: #ff6b00; margin-bottom: 15px;">‚≠ê ' + pois.length + ' Favorite POI(s)</h3>';

        pois.forEach(poi => {
            const typeName = poi.type ? poi.type.name : 'Unknown';

            html += `
                <div class="poi-card">
                    <h4>‚≠ê ${poi.name}</h4>
                    <div style="margin-bottom: 10px;">
                        <span class="poi-type-badge">${typeName}</span>
                    </div>
                    <p class="description">${poi.description || 'No description'}</p>
                    <p class="location">üìç ${poi.address || 'No address'}</p>
                    <p class="location">üåç Lat: ${poi.latitude}, Lng: ${poi.longitude}</p>
                </div>
            `;
        });

        listDiv.innerHTML = html;
    }

    // Modal click outside to close
    window.onclick = function(event) {
        const loginModal = document.getElementById('loginModal');
        if (event.target === loginModal) {
            closeLoginModal();
        }
    }

    // Initialize on page load
    window.onload = function() {
        checkAuth();
    };
</script>
</body>
</html>
